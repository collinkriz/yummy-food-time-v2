<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yummy Food Time</title>
    <style>
        /* ============================================
           STANDARDIZED ANIMATIONS & TRANSITIONS
           ============================================
           
           Standard timings:
           - Fast: 0.15s (hover feedback)
           - Normal: 0.25s (most UI interactions)
           - Slow: 0.4s (view transitions, large movements)
           
           Standard easings:
           - ease-out: Most interactions (snappy end)
           - ease-in-out: Smooth both ways
           - cubic-bezier(0.4, 0, 0.2, 1): Material design (best for views)
        */
        
        /* Global animation settings */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Improve touch scrolling on iOS */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Better default tap behavior for all interactive elements */
        button, a, input[type="button"], input[type="submit"], 
        [onclick], [role="button"], .clickable {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            /* Prevent text size adjustment on orientation change */
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #F5F1E8;
            min-height: 100vh;
            padding-bottom: 40px;
            position: relative;
        }
        
        /* Subtle texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(74, 74, 31, 0.02) 2px,
                    rgba(74, 74, 31, 0.02) 4px
                );
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 12px;
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
            padding: 28px 24px;
            margin-bottom: 20px;
            box-shadow: 
                8px 8px 0 rgba(74, 74, 31, 0.3),
                0 8px 24px rgba(0, 0, 0, 0.15);
            border: 4px solid #4A4A1F;
            position: relative;
            overflow: hidden;
        }
        
        .header::before,
        .header::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: #FF9800;
            border: 3px solid #4A4A1F;
        }
        
        .header::before {
            top: -30px;
            left: -30px;
            transform: rotate(45deg);
        }
        
        .header::after {
            bottom: -30px;
            right: -30px;
            transform: rotate(45deg);
            background: #6B6B3D;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 24px 20px;
            }
            
            .header::before,
            .header::after {
                width: 40px;
                height: 40px;
            }
            
            .header::before {
                top: -20px;
                left: -20px;
            }
            
            .header::after {
                bottom: -20px;
                right: -20px;
            }
        }
        
        h1 {
            color: #4A4A1F;
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 8px;
            text-shadow: 
                3px 3px 0 rgba(255, 255, 255, 0.4),
                -1px -1px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            letter-spacing: -1px;
            text-transform: uppercase;
            cursor: pointer;
            z-index: 2;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 32px;
            }
            
            /* Logo responsive sizing */
            .header > div[onclick="goHome()"] > div {
                font-size: 28px !important;
                letter-spacing: 1px !important;
            }
        }
        
        .subtitle {
            color: #4A4A1F;
            font-size: 16px;
            font-weight: 700;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 2;
        }
        
        @media (max-width: 768px) {
            .subtitle {
                font-size: 14px;
            }
        }
        
        /* TOP BUTTONS */
        .top-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
            position: relative;
            z-index: 2;
        }
        
        .top-btn {
            padding: 10px 14px;
            background: #F5F1E8;
            border: 3px solid #4A4A1F;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 3px 3px 0 rgba(74, 74, 31, 0.25);
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .top-btn .icon {
            font-size: 18px;
            line-height: 1;
        }
        
        .top-btn:active {
            background: #FF9800;
            color: white;
            transform: translateY(-1px) scale(0.98);
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.3);
            transition-duration: 0.15s;
        }
        
        @media (max-width: 768px) {
            .top-buttons {
                gap: 8px;
                margin-top: 14px;
            }
            
            .top-btn {
                padding: 8px 10px;
                font-size: 11px;
                gap: 6px;
            }
            
            .top-btn .icon {
                font-size: 16px;
            }
        }
        
        /* VIEWS */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CHOICE CARDS (Take Out / Cook at Home) */
        .choice-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }
        
        @media (max-width: 768px) {
            .choice-cards {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .choice-card {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .choice-card::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            transition: top 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        
        .choice-card:active::before {
            top: 0;
        }
        
        .choice-card:active {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 9px 9px 0 rgba(74, 74, 31, 0.25);
            transition-duration: 0.15s;
        }
        
        .choice-card:active .choice-icon {
            transform: scale(1.1) rotate(3deg);
        }
        
        .choice-card:active .choice-title {
            color: white;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        .choice-icon {
            font-size: 80px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        
        .choice-title {
            font-size: 28px;
            font-weight: 900;
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        
        @media (max-width: 768px) {
            .choice-card {
                padding: 50px 20px;
            }
            
            .choice-icon {
                font-size: 64px;
            }
            
            .choice-title {
                font-size: 24px;
            }
        }
        
        /* FILTER TILES */
        .filter-section {
            margin-top: 20px;
        }
        
        /* Progress Dots */
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .progress-dots .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #DDD;
            border: 2px solid #4A4A1F;
            transition: all 0.2s ease;
        }
        
        .progress-dots .dot.active {
            background: #FF9800;
            transform: scale(1.3);
        }
        
        .filter-section h2 {
            color: #4A4A1F;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 14px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .filter-section {
                margin-top: 6px;
            }
            
            .filter-section h2 {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            .progress-dots {
                margin-bottom: 12px;
            }
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 18px;
        }
        
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 14px;
            }
        }
        
        .filter-tile {
            background: white;
            border: 4px solid #B4B85E;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 4px 0 rgba(180, 184, 94, 0.2);
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .filter-tile {
                padding: 16px 10px;
            }
        }
        
        .filter-tile:active {
            border-color: #FF9800;
            transform: translateY(-3px) scale(0.98);
            box-shadow: 5px 5px 0 rgba(255, 152, 0, 0.25);
            transition-duration: 0.15s;
        }
        
        /* Multi-select: Both .active and .selected work */
        .filter-tile.active,
        .filter-tile.selected {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-color: #4A4A1F;
            color: white;
            transform: scale(1.04);
            box-shadow: 6px 6px 0 rgba(255, 152, 0, 0.4);
        }
        
        .filter-tile.active:active,
        .filter-tile.selected:active {
            transform: scale(1.02) translateY(-2px);
            box-shadow: 5px 5px 0 rgba(255, 152, 0, 0.3);
        }
        
        .filter-tile.random {
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            border-color: #4A4A1F;
            color: #FFC107;
        }
        
        .filter-tile.random:active {
            transform: scale(1.04) rotate(1deg);
            border-color: #FFC107;
            box-shadow: 5px 5px 0 rgba(107, 107, 61, 0.4);
        }
        
        
        .filter-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .filter-icon {
                font-size: 36px;
                margin-bottom: 6px;
            }
        }
        
        .filter-name {
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
        }
        
        @media (max-width: 768px) {
            .filter-name {
                font-size: 14px;
            }
        }
        
        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            color: #FFC107;
            border: 4px solid #4A4A1F;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 5px 0 rgba(74, 74, 31, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            -webkit-tap-highlight-color: rgba(255, 193, 7, 0.3);
        }
        
        .filter-btn:active {
            transform: translateY(-3px) scale(0.98);
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.35);
            transition-duration: 0.15s;
        }
        
        @media (max-width: 768px) {
            .filter-btn {
                padding: 14px 30px;
                font-size: 16px;
            }
        }
        
        /* RECOMMENDATION SCREEN */
        .recommendation {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 40px 30px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            margin-top: 30px;
        }
        
        .rec-title {
            font-size: 32px;
            font-weight: 900;
            color: #FF9800;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rec-info-header {
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            border: 3px solid #B4B85E;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .rec-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #4A4A1F;
        }
        
        .rec-info-item span {
            font-size: 20px;
        }
        
        /* Recipe Toggle Buttons (separate from content box) */
        .recipe-toggles {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        .recipe-toggle {
            flex: 1;
            max-width: 200px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #F5F1E8 0%, #E8E4D8 100%);
            border: 4px solid #4A4A1F;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            box-shadow: 3px 3px 0 rgba(74, 74, 31, 0.2);
            border-radius: 8px;
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.2);
        }
        
        .recipe-toggle:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.25);
        }
        
        .recipe-toggle.active {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            box-shadow: 4px 4px 0 rgba(255, 152, 0, 0.3);
        }
        
        .recipe-toggle.active:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 3px 3px 0 rgba(255, 152, 0, 0.25);
        }
        
        /* Recipe Content Box - optimized for mobile */
        .recipe-content-box {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 20px 16px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .recipe-section {
            display: none;
        }
        
        .recipe-section.active {
            display: block;
        }
        
        .recipe-section h4 {
            font-size: 18px;
            font-weight: 800;
            color: #4A4A1F;
            margin-bottom: 16px;
            text-transform: uppercase;
        }
        
        .recipe-section ul {
            margin-left: 0;
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .recipe-section li {
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 16px;
            color: #333;
        }
        
        .recipe-section p {
            margin-bottom: 0;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 16px;
            color: #333;
        }
        
        /* Mobile optimizations for recipe detail */
        @media (max-width: 768px) {
            .recipe-content-box {
                padding: 16px 12px;
                margin-left: -4px;
                margin-right: -4px;
                width: calc(100% + 8px);
            }
            
            .recipe-toggle {
                font-size: 13px;
                padding: 12px 16px;
                max-width: none;
            }
            
            .recipe-section li {
                font-size: 15px;
                margin-bottom: 10px;
            }
            
            .recipe-section p {
                font-size: 15px;
            }
        }
        
        .rec-content {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
        }
        
        .rec-details {
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            border: 4px solid #4A4A1F;
            border-bottom: none;
            padding: 20px;
            margin-bottom: 0;
        }
        
        .back-btn {
            background: linear-gradient(135deg, #78909C 0%, #607D8B 100%);
            color: white;
            padding: 14px 30px;
            border: 4px solid #4A4A1F;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(69, 90, 100, 0.3);
            text-transform: uppercase;
            margin-bottom: 16px;
            display: inline-block;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            -webkit-tap-highlight-color: rgba(120, 144, 156, 0.3);
        }
        
        @media (max-width: 768px) {
            .back-btn {
                margin-bottom: 10px;
                padding: 12px 24px;
                font-size: 14px;
            }
        }
        
        .back-btn:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 5px 5px 0 rgba(69, 90, 100, 0.35);
            transition-duration: 0.15s;
        }
        
        /* FLOATING CHAT BUTTON */
        .chat-float-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border: 4px solid #4A4A1F;
            border-radius: 50%;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                4px 4px 0 rgba(74, 74, 31, 0.3);
            z-index: 1000;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.3);
        }
        
        .chat-float-btn:active {
            transform: scale(1.08) rotate(6deg);
            box-shadow: 
                0 5px 14px rgba(0, 0, 0, 0.35),
                5px 5px 0 rgba(74, 74, 31, 0.35);
            transition-duration: 0.15s;
        }
        
        @media (max-width: 768px) {
            .chat-float-btn {
                width: 56px;
                height: 56px;
                font-size: 28px;
                bottom: 20px;
                right: 20px;
            }
        }
        
        /* CHAT OVERLAY */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .chat-overlay.active {
            display: flex;
        }
        
        .chat-box {
            background: white;
            border: 4px solid #4A4A1F;
            box-shadow: 8px 8px 0 rgba(74, 74, 31, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
            border-bottom: 4px solid #4A4A1F;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            font-size: 24px;
            font-weight: 900;
            color: #4A4A1F;
            text-transform: uppercase;
        }
        
        .chat-close {
            background: #EF5350;
            border: 3px solid #4A4A1F;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            min-height: 200px;
            max-height: 400px;
        }
        
        .chat-message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border: 3px solid;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
            font-weight: 600;
            max-width: 80%;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
            color: white;
            border-color: #0288D1;
            margin-left: auto;
        }
        
        .chat-message.assistant {
            background: white;
            color: #333;
            border-color: #4A4A1F;
            margin-right: auto;
        }
        
        .chat-input-area {
            border-top: 4px solid #4A4A1F;
            padding: 16px;
            background: white;
            display: flex;
            gap: 12px;
        }
        
        #chatInput {
            flex: 1;
            padding: 12px;
            border: 3px solid #B4B85E;
            font-size: 15px;
            font-family: inherit;
            font-weight: 600;
        }
        
        #chatInput:focus {
            outline: none;
            border-color: #FF9800;
        }
        
        #sendChatBtn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            color: #FFC107;
            border: 3px solid #4A4A1F;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        
        .spinner {
            border: 4px solid rgba(74, 74, 31, 0.2);
            border-top: 4px solid #FF9800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* CARD */
        .card {
            background: white;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            border: 4px solid #4A4A1F;
            border-radius: 8px;
        }
        
        /* Clickable Card - Mobile Optimized */
        .clickable-card {
            cursor: pointer;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.2);
        }
        
        .clickable-card:active {
            transform: translateY(-2px) scale(0.99);
            box-shadow: 7px 7px 0 rgba(74, 74, 31, 0.25);
        }
        
        /* Item Cards - Retro Style */
        .item-card {
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            border: 3px solid #B4B85E;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 rgba(180, 184, 94, 0.2);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }
        
        .item-name {
            font-size: 17px;
            font-weight: 700;
            color: #4A4A1F;
            flex: 1;
            line-height: 1.3;
        }
        
        .item-name input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            font-weight: 700;
            border: 2px solid #B4B85E;
            border-radius: 4px;
            background: white;
        }
        
        .item-price {
            font-size: 17px;
            font-weight: 800;
            color: #FF9800;
            white-space: nowrap;
        }
        
        .item-price input {
            width: 80px;
            padding: 6px;
            font-size: 16px;
            font-weight: 700;
            border: 2px solid #B4B85E;
            border-radius: 4px;
            text-align: right;
            background: white;
        }
        
        .label-text {
            font-size: 12px;
            font-weight: 800;
            color: #6B6B3D;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            margin-top: 12px;
        }
        
        /* Assignment Buttons */
        .assignment-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .assign-btn {
            flex: 1;
            padding: 10px;
            border: 3px solid #B4B85E;
            background: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .assign-btn:active {
            transform: translateY(-1px) scale(0.97);
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.15);
        }
        
        .assign-btn.collin {
            color: #1890ff;
            border-color: #1890ff;
        }
        
        .assign-btn.collin:active {
            background: rgba(24, 144, 255, 0.1);
        }
        
        .assign-btn.collin.selected {
            background: #1890ff;
            color: white;
            border-color: #4A4A1F;
        }
        
        .assign-btn.collin.selected:active {
            background: #0d7ae6;
        }
        
        .assign-btn.emily {
            color: #722ed1;
            border-color: #722ed1;
        }
        
        .assign-btn.emily:active {
            background: rgba(114, 46, 209, 0.1);
        }
        
        .assign-btn.emily.selected {
            background: #722ed1;
            color: white;
            border-color: #4A4A1F;
        }
        
        .assign-btn.emily.selected:active {
            background: #5e22b3;
        }
        
        /* Star Rating */
        .stars {
            display: flex;
            gap: 4px;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .star {
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .star.empty {
            color: #DDD;
        }
        
        .star.empty:active {
            color: #faad14;
            transform: scale(1.2);
        }
        
        .star.filled {
            color: #faad14;
            filter: drop-shadow(0 2px 4px rgba(250, 173, 20, 0.3));
        }
        
        .star.filled:active {
            transform: scale(1.25);
            filter: drop-shadow(0 4px 8px rgba(250, 173, 20, 0.5));
        }
        
        /* Notes Textarea */
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #B4B85E;
            border-radius: 6px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            resize: vertical;
            min-height: 60px;
            background: white;
        }
        
        textarea:focus {
            outline: none;
            border-color: #FF9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.1);
        }
        
        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
            border: 3px solid #B4B85E;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 3px 3px 0 rgba(180, 184, 94, 0.2);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
            color: #4A4A1F;
        }
        
        .summary-row.total {
            border-top: 3px solid #B4B85E;
            margin-top: 8px;
            padding-top: 12px;
            font-size: 20px;
            font-weight: 800;
            color: #FF9800;
        }
        
        /* Restaurant Info */
        .restaurant-info {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 3px solid #B4B85E;
        }
        
        .restaurant-name {
            font-size: 24px;
            font-weight: 900;
            color: #4A4A1F;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .order-date {
            font-size: 14px;
            color: #6B6B3D;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .delivery-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
            border: 2px solid #4A4A1F;
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.2);
        }
        
        /* Edit Mode Buttons */
        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed #B4B85E;
        }
        
        .edit-item-btn, .save-item-btn, .cancel-item-btn, .delete-item-btn {
            flex: 1;
            padding: 8px 12px;
            border: 3px solid #4A4A1F;
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.2);
            -webkit-tap-highlight-color: transparent;
        }
        
        .edit-item-btn {
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            color: #FFC107;
        }
        
        .save-item-btn {
            background: linear-gradient(135deg, #52c41a 0%, #3fa218 100%);
            color: white;
        }
        
        .cancel-item-btn {
            background: linear-gradient(135deg, #8c8c8c 0%, #696969 100%);
            color: white;
        }
        
        .delete-item-btn {
            background: linear-gradient(135deg, #ff4d4f 0%, #cf1322 100%);
            color: white;
        }
        
        .edit-item-btn:active, .save-item-btn:active, 
        .cancel-item-btn:active, .delete-item-btn:active {
            transform: translateY(-2px) scale(0.97);
            box-shadow: 3px 3px 0 rgba(74, 74, 31, 0.25);
            transition-duration: 0.15s;
        }
            transition-duration: 0.1s;
        }
        
        /* Person Badge in View Mode */
        .person-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            margin-top: 8px;
            border: 2px solid #4A4A1F;
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.15);
        }
        
        .person-badge.collin {
            background: #1890ff;
            color: white;
        }
        
        .person-badge.emily {
            background: #722ed1;
            color: white;
        }
        
        /* Rating Display in View Mode */
        .rating-display {
            font-size: 24px;
            color: #faad14;
            margin-top: 8px;
        }
        
        /* Notes Display */
        .notes-display {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #B4B85E;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .item-card {
                padding: 14px;
            }
            
            .item-name {
                font-size: 16px;
            }
            
            .stars {
                font-size: 24px;
            }
            
            .assign-btn {
                font-size: 12px;
                padding: 8px;
            }
        }
        
        /* UPLOAD AREA STYLING */
        .upload-area {
            border: 4px dashed #FF9800;
            padding: 60px 30px;
            text-align: center;
            background: linear-gradient(135deg, #FFF9E6 0%, #FFFBF0 100%);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            margin: 20px 0;
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.2);
        }
        
        .upload-area:active {
            border-color: #6B6B3D;
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF9E6 100%);
            transform: translateY(-2px) scale(0.99);
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.15);
        }
        
        .upload-icon {
            font-size: 72px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        input[type="file"] {
            display: none;
        }
        
        .preview {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview img {
            max-width: 100%;
            height: auto;
            border: 4px solid #4A4A1F;
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.2);
        }
        
        button {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
            color: white;
            border: 4px solid #4A4A1F;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.3);
            -webkit-tap-highlight-color: rgba(255, 152, 0, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translate(2px, 2px) scale(0.98);
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.3);
        }
        
        button:disabled {
            background: #CCC;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        
        .status {
            padding: 16px 20px;
            margin: 16px 0;
            border: 4px solid;
            font-weight: 700;
            text-align: center;
        }
        
        .status.loading {
            background: #E3F2FD;
            border-color: #2196F3;
            color: #1565C0;
        }
        
        .status.success {
            background: #E8F5E9;
            border-color: #4CAF50;
            color: #2E7D32;
        }
        
        .status.error {
            background: #FFEBEE;
            border-color: #EF5350;
            color: #C62828;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        /* ============================================
           TAG SYSTEM STYLES
           ============================================ */

        /* Tag Container */
        .item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        /* Base Tag Style */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            transition: all 0.15s ease-out;
            cursor: default;
        }

        /* Tag Colors by Category */
        .tag-course { background: #ef4444; }
        .tag-meal-type { background: #3b82f6; }
        .tag-dietary { background: #10b981; }
        .tag-cuisine { background: #8b5cf6; }
        .tag-cooking-method { background: #f97316; }
        .tag-time { background: #eab308; }
        .tag-difficulty { background: #6b7280; }
        .tag-characteristics { background: #14b8a6; }

        .tag.removable {
            padding-right: 8px;
            cursor: pointer;
        }

        .tag.removable:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .tag.removable::after {
            content: " ‚úï";
            margin-left: 6px;
            font-size: 14px;
            font-weight: bold;
        }

        .tag-editor {
            background: #f8f9fa;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .tag-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .tag-editor-title {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
        }

        .suggest-tags-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease-out;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        .suggest-tags-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .suggest-tags-btn:active {
            transform: translateY(0);
        }

        .suggest-tags-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .current-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 32px;
            margin-bottom: 12px;
        }

        .current-tags-empty {
            color: #9ca3af;
            font-size: 13px;
            font-style: italic;
            padding: 6px 0;
        }

        .tag-suggestions {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        .tag-suggestions-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-suggestions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-suggestion {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            background: white;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }

        .tag-suggestion:hover {
            border-color: #9ca3af;
            transform: scale(1.05);
            background: #f9fafb;
        }

        .tag-suggestion:active {
            transform: scale(0.98);
        }

        .tag-suggestion::before {
            content: "+ ";
            margin-right: 2px;
            font-weight: bold;
        }

        .tag-suggestion.suggest-course { border-color: #fca5a5; background: #fef2f2; }
        .tag-suggestion.suggest-meal-type { border-color: #93c5fd; background: #eff6ff; }
        .tag-suggestion.suggest-dietary { border-color: #6ee7b7; background: #f0fdf4; }
        .tag-suggestion.suggest-cuisine { border-color: #c4b5fd; background: #faf5ff; }
        .tag-suggestion.suggest-cooking-method { border-color: #fdba74; background: #fff7ed; }
        .tag-suggestion.suggest-time { border-color: #fde047; background: #fefce8; }
        .tag-suggestion.suggest-difficulty { border-color: #d1d5db; background: #f9fafb; }
        .tag-suggestion.suggest-characteristics { border-color: #5eead4; background: #f0fdfa; }

        .tag-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 13px;
            padding: 8px 0;
        }

        .tag-loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tag-error {
            color: #ef4444;
            font-size: 12px;
            padding: 6px 10px;
            background: #fef2f2;
            border-radius: 6px;
            margin-top: 8px;
        }

        @media (max-width: 640px) {
            .tag {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .tag-editor {
                padding: 12px;
            }
            
            .suggest-tags-btn {
                font-size: 11px;
                padding: 5px 10px;
            }
            
            .tag-suggestion {
                font-size: 11px;
                padding: 3px 8px;
            }
        }

        @media print {
            .tag-editor {
                display: none;
            }
            
            .tag.removable::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div onclick="goHome()" style="cursor: pointer; text-align: center; margin-bottom: 16px;">
                <div style="font-size: 36px; font-weight: 900; color: #4A4A1F; text-transform: uppercase; letter-spacing: 2px; text-shadow: 3px 3px 0 rgba(255, 255, 255, 0.4), -1px -1px 0 rgba(0, 0, 0, 0.1); line-height: 1; margin-bottom: 4px;">
                    YUMMY FOOD TIME
                </div>
                <p class="subtitle" style="margin: 0;">Your food decision helper</p>
            </div>
            
            <div class="top-buttons">
                <button class="top-btn" onclick="showLogMeal()"><span class="icon">üìù</span> Log Meal</button>
                <button class="top-btn" onclick="showMealHistory()"><span class="icon">üìã</span> History</button>
                <button class="top-btn" onclick="showRecipeList()"><span class="icon">üìñ</span> Recipes</button>
                <button class="top-btn" onclick="showOrders()"><span class="icon">üçî</span> Orders</button>
            </div>
        </div>
        
        <!-- HOME VIEW -->
        <div id="homeView" class="view active">
            <div class="choice-cards">
                <div class="choice-card" onclick="selectChoice('takeout')">
                    <div class="choice-icon">üçï</div>
                    <div class="choice-title">Take Out Ideas</div>
                </div>
                <div class="choice-card" onclick="selectChoice('cooking')">
                    <div class="choice-icon">üë©üèª‚Äçüç≥</div>
                    <div class="choice-title">Recipe Ideas</div>
                </div>
            </div>
        </div>
        
        <!-- FILTER VIEW -->
        <div id="filterView" class="view">
            <button class="back-btn" onclick="goBackFromFilters()">‚Üê Back</button>
            
            <div class="filter-section">
                <!-- Progress Dots -->
                <div id="progressDots" class="progress-dots" style="display: none;">
                    <span class="dot active"></span>
                    <span class="dot"></span>
                </div>
                
                <h2 id="filterTitle">What are you looking for?</h2>
                <div class="filter-grid" id="filterGrid"></div>
                
                <div class="filter-actions">
                    <button class="filter-btn" id="filterNextBtn" onclick="handleFilterNext()">Next ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- RECOMMENDATION VIEW -->
        <div id="recommendationView" class="view">
            <button class="back-btn" onclick="backToFilters()">‚Üê Back</button>
            
            <div class="recommendation">
                <div class="rec-title" id="recTitle"></div>
                <div class="rec-content" id="recContent"></div>
                <div class="filter-actions">
                    <button class="filter-btn" onclick="getRecommendation()">üé≤ Try Again</button>
                </div>
            </div>
        </div>
        
        <!-- LOG MEAL VIEW -->
        <div id="logMealView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <h2 style="text-align: center; color: #4A4A1F; font-size: 28px; font-weight: 900; text-transform: uppercase; margin-bottom: 30px;">
                Log a Meal
            </h2>
            
            <div class="choice-cards">
                <div class="choice-card" onclick="showUpload()">
                    <div class="choice-icon">üçî</div>
                    <div class="choice-title">Take Out</div>
                </div>
                <div class="choice-card" onclick="showRecipeListForLogging()">
                    <div class="choice-icon">üè†</div>
                    <div class="choice-title">Home Cooked</div>
                </div>
            </div>
        </div>
        
        <!-- UPLOAD VIEW -->
        <div id="uploadView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üì∏ Upload Receipt</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∏</div>
                    <div style="color: #666;">Tap to upload food delivery receipt</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div id="preview" style="display: none;">
                    <img id="previewImage" alt="Preview">
                </div>
                
                <button id="extractBtn" disabled>Extract Order Info</button>
                
                <div id="status" style="display: none;"></div>
            </div>
            
            <div id="results" style="display: none;"></div>
        </div>
        
        <!-- ORDERS VIEW (for order database / recommendations) -->
        <div id="ordersView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üìã Order Database</h2>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 24px;">
                    <input 
                        type="text" 
                        id="historySearch" 
                        placeholder="üîç Search orders by restaurant..." 
                        style="width: 100%; padding: 16px; font-size: 16px; border: 4px solid #4A4A1F; border-radius: 12px; font-weight: 600; background: white;"
                        oninput="filterOrders()"
                    />
                </div>
                
                <!-- Order Count -->
                <div id="orderCount" style="margin-bottom: 16px; font-weight: 600; color: #6B6B3D; text-align: center;"></div>
            </div>
            
            <div id="ordersList"></div>
            <div id="orderDetail" style="display: none;"></div>
        </div>
        
        <!-- MEAL HISTORY VIEW -->
        <div id="mealHistoryView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üìã Meal History</h2>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 24px;">
                    <input 
                        type="text" 
                        id="mealHistorySearch" 
                        placeholder="üîç Search meals..." 
                        style="width: 100%; padding: 16px; font-size: 16px; border: 4px solid #4A4A1F; border-radius: 12px; font-weight: 600; background: white;"
                        oninput="filterMealHistory()"
                    />
                </div>
                
                <!-- Meal Count -->
                <div id="mealCount" style="margin-bottom: 16px; font-weight: 600; color: #6B6B3D; text-align: center;"></div>
            </div>
            
            <div id="mealsList"></div>
            <div id="mealDetail" style="display: none;"></div>
        </div>
        
        <!-- RECIPE LIST VIEW -->
        <div id="recipeListView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üìñ Recipe Library</h2>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 24px;">
                    <input 
                        type="text" 
                        id="recipeSearch" 
                        placeholder="üîç Search recipes..." 
                        style="width: 100%; padding: 16px; font-size: 16px; border: 4px solid #4A4A1F; border-radius: 12px; font-weight: 600; background: white;"
                        oninput="filterRecipes()"
                    />
                </div>
                
                <!-- Recipe Count -->
                <div id="recipeCount" style="margin-bottom: 16px; font-weight: 600; color: #6B6B3D; text-align: center;"></div>
            </div>
            
            <!-- Recipe List (cards outside main card for spacing) -->
            <div id="recipeListContainer"></div>
        </div>
    </div>
    
    <!-- FLOATING CHAT BUTTON -->
    <div class="chat-float-btn" onclick="toggleChat()">üí¨</div>
    
    <!-- CHAT OVERLAY -->
    <div class="chat-overlay" id="chatOverlay" onclick="closeChat(event)">
        <div class="chat-box" onclick="event.stopPropagation()">
            <div class="chat-header">
                <h3>ü§ñ Chat</h3>
                <div class="chat-close" onclick="closeChat()">√ó</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    What can I help you find?
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Ask me anything..." />
                <button id="sendChatBtn" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentOrder = null;
        let selectedFile = null;
        let currentView = 'home';
        let currentChoice = null;
        let selectedFilters = new Set();
        let chatHistory = [];
        let currentFilterPage = 1; // Track which page of filters we're on
        
        // ============================================
        // TAG SYSTEM - 80+ Tags in 8 Categories
        // ============================================

        const TAG_SYSTEM = {
            'Meal Type': ['Breakfast', 'Lunch', 'Dinner', 'Brunch', 'Snack'],
            'Course': ['Appetizer', 'Main Dish', 'Side Dish', 'Salad', 'Soup', 'Dessert', 'Beverage', 'Sauce/Condiment'],
            'Dietary': ['Vegetarian', 'Vegan', 'Gluten-Free', 'Dairy-Free', 'Nut-Free', 'Low-Carb', 'Keto', 'Paleo'],
            'Cuisine': ['American', 'Italian', 'Mexican', 'Asian', 'Indian', 'Mediterranean', 'French', 'Thai', 'Korean', 'Japanese', 'Chinese', 'Greek', 'Middle Eastern'],
            'Cooking Method': ['Baked', 'Grilled', 'Fried', 'Slow Cooker', 'Instant Pot', 'One-Pot', 'No-Cook', 'Roasted', 'Saut√©ed', 'Steamed'],
            'Time': ['Quick (< 30 min)', 'Medium (30-60 min)', 'Long (> 60 min)'],
            'Difficulty': ['Easy', 'Medium', 'Hard'],
            'Characteristics': ['Healthy', 'Comfort Food', 'Kid-Friendly', 'Party Food', 'Make-Ahead', 'Meal Prep', 'Spicy', 'Sweet', 'Savory', 'Fresh', 'Hearty', 'Light']
        };

        function getTagCategory(tagName) {
            for (const [category, tags] of Object.entries(TAG_SYSTEM)) {
                if (tags.includes(tagName)) {
                    return category;
                }
            }
            return 'Characteristics';
        }

        function getCategoryClass(category) {
            return 'tag-' + category.toLowerCase().replace(/ /g, '-');
        }

        function renderTags(tags) {
            if (!tags || tags.length === 0) {
                return '';
            }
            
            return `
                <div class="item-tags">
                    ${tags.map(tag => {
                        const category = getTagCategory(tag);
                        const cssClass = getCategoryClass(category);
                        return `<span class="tag ${cssClass}">${tag}</span>`;
                    }).join('')}
                </div>
            `;
        }

        function renderTagEditor(itemId, currentTags = [], itemName = '', ingredients = '', directions = '', prepTime = '', cookTime = '') {
            const tags = currentTags || [];
            const allTags = Object.values(TAG_SYSTEM).flat();
            const topSuggestions = [];
            for (const [category, categoryTags] of Object.entries(TAG_SYSTEM)) {
                const available = categoryTags.filter(tag => !tags.includes(tag));
                if (available.length > 0) {
                    topSuggestions.push(...available.slice(0, 2));
                }
            }
            
            return `
                <div class="tag-editor" id="tag-editor-${itemId}">
                    <div class="tag-editor-header">
                        <div class="tag-editor-title">üè∑Ô∏è Tags</div>
                        <button type="button" class="suggest-tags-btn" onclick="suggestTags(${itemId}, '${itemName.replace(/'/g, "\\'")}', '${ingredients.replace(/'/g, "\\'")}', '${directions.replace(/'/g, "\\'")}', '${prepTime}', '${cookTime}')">
                            ‚ú® AI Suggest
                        </button>
                    </div>
                    
                    <div class="current-tags" id="current-tags-${itemId}">
                        ${tags.length === 0 
                            ? '<div class="current-tags-empty">No tags yet. Click AI Suggest or add from below.</div>'
                            : tags.map(tag => {
                                const category = getTagCategory(tag);
                                const cssClass = getCategoryClass(category);
                                return `<span class="tag ${cssClass} removable" onclick="removeTag(${itemId}, '${tag.replace(/'/g, "\\'")}')">${tag}</span>`;
                            }).join('')
                        }
                    </div>
                    
                    <div class="tag-suggestions">
                        <div class="tag-suggestions-title">Quick Add</div>
                        <div class="tag-suggestions-list" id="tag-suggestions-${itemId}">
                            ${topSuggestions.slice(0, 12).map(tag => {
                                const category = getTagCategory(tag);
                                const cssClass = 'suggest-' + category.toLowerCase().replace(/ /g, '-');
                                return `<span class="tag-suggestion ${cssClass}" onclick="addTag(${itemId}, '${tag.replace(/'/g, "\\'")}')">${tag}</span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        async function suggestTags(itemId, itemName, ingredients = '', directions = '', prepTime = '', cookTime = '') {
            const button = event.target;
            const suggestionsDiv = document.getElementById(`tag-suggestions-${itemId}`);
            
            button.disabled = true;
            button.textContent = '‚è≥ Thinking...';
            suggestionsDiv.innerHTML = '<div class="tag-loading"><div class="tag-loading-spinner"></div> AI is analyzing...</div>';
            
            try {
                const response = await fetch('/suggest-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: itemName,
                        ingredients: ingredients,
                        directions: directions,
                        prep_time: prepTime,
                        cook_time: cookTime
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.tags && data.tags.length > 0) {
                    const currentTags = getCurrentTags(itemId);
                    const newSuggestions = data.tags.filter(tag => !currentTags.includes(tag));
                    
                    suggestionsDiv.innerHTML = `
                        <div class="tag-suggestions-title">‚ú® AI Suggestions</div>
                        <div class="tag-suggestions-list">
                            ${newSuggestions.map(tag => {
                                const category = getTagCategory(tag);
                                const cssClass = 'suggest-' + category.toLowerCase().replace(/ /g, '-');
                                return `<span class="tag-suggestion ${cssClass}" onclick="addTag(${itemId}, '${tag.replace(/'/g, "\\'")}')">${tag}</span>`;
                            }).join('')}
                        </div>
                    `;
                    
                    button.textContent = '‚ú® AI Suggest';
                    button.disabled = false;
                } else {
                    throw new Error('No tags suggested');
                }
                
            } catch (error) {
                console.error('Error suggesting tags:', error);
                suggestionsDiv.innerHTML = '<div class="tag-error">‚ö†Ô∏è Could not get suggestions. Try again.</div>';
                button.textContent = '‚ú® AI Suggest';
                button.disabled = false;
            }
        }

        function addTag(itemId, tagName) {
            const currentTagsDiv = document.getElementById(`current-tags-${itemId}`);
            const suggestionsDiv = document.getElementById(`tag-suggestions-${itemId}`);
            
            const currentTags = getCurrentTags(itemId);
            if (currentTags.includes(tagName)) {
                return;
            }
            
            currentTags.push(tagName);
            
            const category = getTagCategory(tagName);
            const cssClass = getCategoryClass(category);
            
            const emptyState = currentTagsDiv.querySelector('.current-tags-empty');
            if (emptyState) {
                emptyState.remove();
            }
            
            const tagElement = document.createElement('span');
            tagElement.className = `tag ${cssClass} removable`;
            tagElement.textContent = tagName;
            tagElement.onclick = () => removeTag(itemId, tagName);
            currentTagsDiv.appendChild(tagElement);
            
            const suggestionElements = suggestionsDiv.querySelectorAll('.tag-suggestion');
            suggestionElements.forEach(el => {
                if (el.textContent.includes(tagName)) {
                    el.remove();
                }
            });
        }

        function removeTag(itemId, tagName) {
            const currentTagsDiv = document.getElementById(`current-tags-${itemId}`);
            const suggestionsDiv = document.getElementById(`tag-suggestions-${itemId}`);
            
            const tags = currentTagsDiv.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.textContent === tagName) {
                    tag.remove();
                }
            });
            
            if (currentTagsDiv.querySelectorAll('.tag').length === 0) {
                currentTagsDiv.innerHTML = '<div class="current-tags-empty">No tags yet. Click AI Suggest or add from below.</div>';
            }
            
            const category = getTagCategory(tagName);
            const cssClass = 'suggest-' + category.toLowerCase().replace(/ /g, '-');
            
            const suggestionElement = document.createElement('span');
            suggestionElement.className = `tag-suggestion ${cssClass}`;
            suggestionElement.textContent = tagName;
            suggestionElement.onclick = () => addTag(itemId, tagName);
            
            const suggestionsList = suggestionsDiv.querySelector('.tag-suggestions-list');
            if (suggestionsList) {
                suggestionsList.appendChild(suggestionElement);
            }
        }

        function getCurrentTags(itemId) {
            const currentTagsDiv = document.getElementById(`current-tags-${itemId}`);
            if (!currentTagsDiv) return [];
            
            const tagElements = currentTagsDiv.querySelectorAll('.tag:not(.current-tags-empty)');
            return Array.from(tagElements).map(el => el.textContent.trim());
        }
        
        const takeoutFilters = [
            { id: 'cheap', icon: 'üí∞', name: 'Cheap' },
            { id: 'healthy', icon: 'ü•ó', name: 'Healthy' },
            { id: 'filling', icon: 'üçó', name: 'Filling' },
            { id: 'fast', icon: '‚ö°', name: 'Fast' },
            { id: 'comfort', icon: 'üçï', name: 'Comfort' }
        ];
        
        // Multi-page cooking filters (2 pages now)
        const cookingFiltersPage1 = [
            { id: 'breakfast', icon: 'üç≥', name: 'Breakfast' },
            { id: 'lunch', icon: 'ü•ó', name: 'Lunch' },
            { id: 'dinner', icon: 'üçΩÔ∏è', name: 'Dinner' },
            { id: 'side', icon: 'ü•î', name: 'Side' },
            { id: 'dessert', icon: 'üç∞', name: 'Dessert' },
            { id: 'any-meal', icon: 'üé≤', name: 'Any Meal', isAny: true }
        ];
        
        const cookingFiltersPage2 = [
            { id: 'healthy', icon: 'ü•ó', name: 'Healthy' },
            { id: 'quick', icon: '‚ö°', name: 'Quick' },
            { id: 'filling', icon: 'üçó', name: 'Filling' },
            { id: 'comfort', icon: 'üßÄ', name: 'Comfort' },
            { id: 'complex', icon: 'üéì', name: 'Complex' },
            { id: 'any-vibe', icon: 'üé≤', name: 'Any Vibe', isAny: true }
        ];
        
        const cookingFilterPages = [
            { filters: cookingFiltersPage1, title: 'What meal(s)?' },
            { filters: cookingFiltersPage2, title: 'What vibe(s)?' }
        ];
        
        // View navigation functions
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.add('active');
            }
        }
        
        function goHome() {
            currentChoice = null;
            selectedFilters.clear();
            currentFilterPage = 1;
            showView('homeView');
        }
        
        function goBackFromFilters() {
            if (currentChoice === 'cooking' && currentFilterPage > 1) {
                // Go back to previous filter page
                currentFilterPage--;
                renderFilterPage();
            } else {
                // Go back to home
                goHome();
            }
        }
        
        function selectChoice(choice) {
            currentChoice = choice;
            selectedFilters.clear();
            currentFilterPage = 1;
            
            renderFilterPage();
            showView('filterView');
        }
        
        function renderFilterPage() {
            const filterGrid = document.getElementById('filterGrid');
            const filterTitle = document.getElementById('filterTitle');
            const progressDots = document.getElementById('progressDots');
            const nextBtn = document.getElementById('filterNextBtn');
            
            if (currentChoice === 'takeout') {
                // Takeout: Single page, no progress dots
                progressDots.style.display = 'none';
                filterTitle.textContent = 'What kind of takeout?';
                nextBtn.textContent = 'Get Recommendation';
                
                filterGrid.innerHTML = takeoutFilters.map(f => `
                    <div class="filter-tile" data-filter="${f.id}" onclick="toggleFilter('${f.id}')">
                        <div class="filter-icon">${f.icon}</div>
                        <div class="filter-name">${f.name}</div>
                    </div>
                `).join('');
                
            } else {
                // Cooking: Multi-page
                progressDots.style.display = 'flex';
                const pageData = cookingFilterPages[currentFilterPage - 1];
                filterTitle.textContent = pageData.title;
                
                // Update progress dots
                document.querySelectorAll('.progress-dots .dot').forEach((dot, index) => {
                    if (index < currentFilterPage) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
                
                // Update button text
                if (currentFilterPage === 2) {
                    const selectedCount = selectedFilters.size;
                    nextBtn.textContent = selectedCount > 0 ? `Get Recommendation (${selectedCount})` : 'Get Recommendation';
                } else {
                    nextBtn.textContent = 'Next ‚Üí';
                }
                
                // Render current page filters
                filterGrid.innerHTML = pageData.filters.map(f => `
                    <div class="filter-tile ${selectedFilters.has(f.id) ? 'active' : ''}" 
                         data-filter="${f.id}" 
                         data-is-any="${f.isAny || false}"
                         onclick="toggleFilter('${f.id}')">
                        <div class="filter-icon">${f.icon}</div>
                        <div class="filter-name">${f.name}</div>
                    </div>
                `).join('');
            }
        }
        
        function toggleFilter(filterId) {
            const tile = document.querySelector(`[data-filter="${filterId}"]`);
            if (!tile) return;
            
            const isAny = tile.dataset.isAny === 'true';
            
            // Get current page filters
            let currentPageFilters;
            if (currentChoice === 'cooking') {
                currentPageFilters = cookingFilterPages[currentFilterPage - 1].filters;
            } else if (currentChoice === 'takeout') {
                currentPageFilters = takeoutFilters;
            }
            
            if (isAny && currentPageFilters) {
                // Selecting "Any X" - clear all other selections from this page
                currentPageFilters.forEach(f => {
                    if (f.id !== filterId) {
                        selectedFilters.delete(f.id);
                        const otherTile = document.querySelector(`[data-filter="${f.id}"]`);
                        if (otherTile) otherTile.classList.remove('active');
                    }
                });
                
                // Toggle the "Any" option
                if (selectedFilters.has(filterId)) {
                    selectedFilters.delete(filterId);
                    tile.classList.remove('active');
                } else {
                    selectedFilters.add(filterId);
                    tile.classList.add('active');
                }
            } else {
                // Selecting specific filter - remove "Any X" if it was selected
                if (currentPageFilters) {
                    const anyFilter = currentPageFilters.find(f => f.isAny);
                    if (anyFilter && selectedFilters.has(anyFilter.id)) {
                        selectedFilters.delete(anyFilter.id);
                        const anyTile = document.querySelector(`[data-filter="${anyFilter.id}"]`);
                        if (anyTile) anyTile.classList.remove('active');
                    }
                }
                
                // Toggle this filter
                if (selectedFilters.has(filterId)) {
                    selectedFilters.delete(filterId);
                    tile.classList.remove('active');
                } else {
                    selectedFilters.add(filterId);
                    tile.classList.add('active');
                }
            }
            
            // Update button text if on last page
            if (currentChoice === 'cooking' && currentFilterPage === 2) {
                const nextBtn = document.getElementById('filterNextBtn');
                const selectedCount = selectedFilters.size;
                nextBtn.textContent = selectedCount > 0 ? `Get Recommendation (${selectedCount})` : 'Get Recommendation';
            }
        }
        
        function handleFilterNext() {
            if (currentChoice === 'takeout' || currentFilterPage === 2) {
                // Get recommendation
                getRecommendation();
            } else {
                // Go to next page
                currentFilterPage++;
                renderFilterPage();
            }
        }
        
        async function getRecommendation(forceRandom = false) {
            const recTitle = document.getElementById('recTitle');
            const recContent = document.getElementById('recContent');
            
            recTitle.textContent = 'Finding recommendation...';
            recContent.innerHTML = '<div class="spinner"></div>';
            showView('recommendationView');
            
            try {
                const params = new URLSearchParams({
                    type: currentChoice,
                    filters: Array.from(selectedFilters).join(','),
                    random: forceRandom
                });
                
                const response = await fetch(`/recommend?${params}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get recommendation');
                }
                
                recTitle.textContent = result.title || (currentChoice === 'takeout' ? 'Order This!' : 'Cook This!');
                recContent.innerHTML = result.recommendation;
                
            } catch (error) {
                console.error('Recommendation error:', error);
                recTitle.textContent = 'Oops!';
                recContent.textContent = error.message || 'Unable to get a recommendation. Please try again.';
            }
        }
        
        function backToFilters() {
            // If viewing recipe detail from recipe list, go back to recipe list
            if (isViewingRecipeDetail && currentChoice === 'cooking') {
                isViewingRecipeDetail = false;
                showView('recipeListView');
                return;
            }
            
            // Otherwise go back to the filter page
            if (currentChoice === 'cooking') {
                currentFilterPage = 2;
                renderFilterPage();
            }
            showView('filterView');
        }
        
        function switchRecipeTab(tabName) {
            document.querySelectorAll('.recipe-toggle').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.recipe-section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-section').classList.add('active');
        }
        
        // Tab switching (legacy - not used in new design)
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'upload') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('upload-tab').classList.add('active');
                currentView = 'upload';
            } else if (tab === 'history') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('history-tab').classList.add('active');
                currentView = 'history';
                loadOrders();
            } else if (tab === 'chat') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('chat-tab').classList.add('active');
                currentView = 'chat';
            }
        }
        
        // Upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const extractBtn = document.getElementById('extractBtn');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        
                        // Only constrain width, let height be flexible for long receipts
                        previewImage.style.maxWidth = '90%';
                        previewImage.style.width = 'auto';
                        previewImage.style.height = 'auto';
                        previewImage.style.maxHeight = 'none';
                        previewImage.style.objectFit = 'contain';
                        
                        preview.style.display = 'block';
                        extractBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        if (extractBtn) {
            extractBtn.addEventListener('click', extractOrder);
        }
        
        async function extractOrder() {
            if (!selectedFile) return;
            
            extractBtn.disabled = true;
            results.style.display = 'none';
            status.style.display = 'block';
            status.className = 'status loading';
            status.innerHTML = '<div class="spinner"></div><div>Analyzing receipt...</div>';
            
            try {
                const formData = new FormData();
                formData.append('image', selectedFile);
                
                const response = await fetch('/extract-order', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to extract order');
                }
                
                status.className = 'status success';
                status.textContent = '‚úÖ Order extracted! Add ratings and save.';
                
                currentOrder = result.data;
                currentOrder.items = currentOrder.items.map((item, i) => ({
                    ...item,
                    id: i,
                    assignedTo: null,
                    rating: 0,
                    notes: ''
                }));
                
                displayOrderForRating(currentOrder);
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            } finally {
                extractBtn.disabled = false;
            }
        }
        
        function displayOrderForRating(order) {
            results.style.display = 'block';
            results.innerHTML = `
                <div class="card">
                    <div class="restaurant-info">
                        <div class="restaurant-name">${order.restaurant}</div>
                        ${order.deliveryService && order.deliveryService !== 'Unknown' ? 
                            `<div class="delivery-badge">${order.deliveryService}</div>` : ''}
                        <div style="color: #666; margin-top: 8px;">üìç ${order.address}</div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px;">Rate Your Items</h3>
                    
                    <div id="itemsList">
                        ${order.items.map((item, i) => `
                            <div class="item-card">
                                <div class="item-header">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">$${item.price.toFixed(2)}</div>
                                </div>
                                
                                <div class="label-text">Who ate this?</div>
                                <div class="assignment-buttons">
                                    <button class="assign-btn collin" onclick="assignItem(${i}, 'Collin')">
                                        üë§ Collin
                                    </button>
                                    <button class="assign-btn emily" onclick="assignItem(${i}, 'Emily')">
                                        üë§ Emily
                                    </button>
                                </div>
                                
                                <div class="label-text">Rating</div>
                                <div class="stars" id="stars-${i}">
                                    ${[1,2,3,4,5].map(star => 
                                        `<span class="star empty" onclick="rateItem(${i}, ${star})">‚òÖ</span>`
                                    ).join('')}
                                </div>
                                
                                <div class="label-text">Notes</div>
                                <textarea 
                                    placeholder="Add your thoughts about this item..."
                                    onchange="updateNotes(${i}, this.value)"
                                ></textarea>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="summary-box">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>$${order.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>$${order.deliveryFee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Service Fee</span>
                            <span>$${order.serviceFee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax</span>
                            <span>$${order.tax.toFixed(2)}</span>
                        </div>
                        ${order.discount !== 0 ? `
                            <div class="summary-row">
                                <span>Discount</span>
                                <span>-$${Math.abs(order.discount).toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="summary-row">
                            <span>Tip</span>
                            <span>$${order.tip.toFixed(2)}</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>$${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <button class="save-btn" onclick="saveOrder()">üíæ Save Order</button>
                </div>
            `;
        }
        
        function assignItem(itemId, person) {
            currentOrder.items[itemId].assignedTo = person;
            
            // Update UI
            const buttons = document.querySelectorAll(`.item-card:nth-child(${itemId + 1}) .assign-btn`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            if (person === 'Collin') {
                buttons[0].classList.add('selected');
            } else {
                buttons[1].classList.add('selected');
            }
        }
        
        function rateItem(itemId, rating) {
            currentOrder.items[itemId].rating = rating;
            
            // Update stars UI
            const stars = document.querySelectorAll(`#stars-${itemId} .star`);
            stars.forEach((star, i) => {
                if (i < rating) {
                    star.className = 'star filled';
                } else {
                    star.className = 'star empty';
                }
            });
        }
        
        function updateNotes(itemId, notes) {
            currentOrder.items[itemId].notes = notes;
        }
        
        async function saveOrder() {
            try {
                status.style.display = 'block';
                status.className = 'status loading';
                status.textContent = 'Saving order...';
                
                // Prepare order data with correct structure
                const orderToSave = {
                    restaurant: currentOrder.restaurant,
                    address: currentOrder.address,
                    deliveryService: currentOrder.deliveryService,
                    subtotal: parseFloat(currentOrder.subtotal) || 0,
                    deliveryFee: parseFloat(currentOrder.deliveryFee) || 0,
                    serviceFee: parseFloat(currentOrder.serviceFee) || 0,
                    tax: parseFloat(currentOrder.tax) || 0,
                    discount: parseFloat(currentOrder.discount) || 0,
                    tip: parseFloat(currentOrder.tip) || 0,
                    total: parseFloat(currentOrder.total) || 0,
                    items: currentOrder.items.map(item => ({
                        name: item.name,
                        price: parseFloat(item.price) || 0,
                        assignedTo: item.assignedTo || null,
                        rating: parseInt(item.rating) || 0,
                        notes: item.notes || null
                    }))
                };
                
                console.log('Sending order data:', orderToSave);
                
                const response = await fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderToSave)
                });
                
                const result = await response.json();
                console.log('Server response:', result);
                
                if (!response.ok) {
                    console.error('Server error:', result);
                    // Show detailed error
                    throw new Error(result.error + (result.details ? '\n\nDetails: ' + result.details : ''));
                }
                
                status.className = 'status success';
                status.innerHTML = `
                    ‚úÖ Order saved successfully!<br><br>
                    <button onclick="markOrderAsMeal(${result.orderId})" 
                            style="padding: 12px 24px; background: linear-gradient(135deg, #52c41a 0%, #3fa218 100%); color: white; font-size: 14px; font-weight: 800; border: 3px solid #4A4A1F; border-radius: 8px; cursor: pointer; text-transform: uppercase; margin-top: 8px;">
                        üìù Log This Meal
                    </button>
                `;
                
                // Store the order ID for potential logging
                window.lastSavedOrderId = result.orderId;
                
                setTimeout(() => {
                    // Reset form
                    selectedFile = null;
                    currentOrder = null;
                    preview.style.display = 'none';
                    results.style.display = 'none';
                    status.style.display = 'none';
                    extractBtn.disabled = true;
                    fileInput.value = '';
                    
                    // Switch to history
                    switchTab('history');
                }, 1500);
                
            } catch (error) {
                console.error('Save order error:', error);
                status.className = 'status error';
                status.innerHTML = `‚ùå Error: ${error.message}<br><br><small>Check if database is connected in Railway</small>`;
            }
        }
        
        // History functionality
        let allOrders = [];
        
        async function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            const orderCount = document.getElementById('orderCount');
            ordersList.innerHTML = '<div class="card"><p style="text-align: center; color: #999;">Loading orders...</p></div>';
            
            try {
                const response = await fetch('/orders');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load orders');
                }
                
                allOrders = result.orders;
                displayOrders(allOrders);
                
            } catch (error) {
                ordersList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #EF5350;">‚ùå Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function filterOrders() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayOrders(allOrders);
                return;
            }
            
            const filtered = allOrders.filter(order => {
                return order.restaurant.toLowerCase().includes(searchTerm) ||
                       (order.delivery_service && order.delivery_service.toLowerCase().includes(searchTerm));
            });
            
            displayOrders(filtered);
        }
        
        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            const orderCount = document.getElementById('orderCount');
            
            orderCount.textContent = `${orders.length} order${orders.length !== 1 ? 's' : ''}`;
            
            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="card empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div style="font-size: 18px; margin-bottom: 10px; font-weight: 600;">No orders found</div>
                        <div style="color: #999;">Try a different search or upload your first receipt!</div>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = orders.map(order => `
                <div class="card clickable-card" onclick="viewOrder(${order.id})">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #999; font-weight: 600; margin-bottom: 8px;">
                                ${new Date(order.created_at).toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    month: 'short', 
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                            
                            <h3 style="font-size: 20px; font-weight: 900; color: #FF9800; margin-bottom: 8px;">
                                ${order.restaurant}
                            </h3>
                            
                            ${order.delivery_service && order.delivery_service !== 'Unknown' ? `
                                <div style="display: inline-block; background: linear-gradient(135deg, #6B6B3D 0%, #4A4A1F 100%); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 700; color: white; margin-bottom: 8px;">
                                    ${order.delivery_service}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; font-size: 14px; color: #666; font-weight: 600;">
                                <span>üçΩÔ∏è ${order.items.length} item${order.items.length !== 1 ? 's' : ''}</span>
                                <span style="color: #4CAF50; font-weight: 900; font-size: 16px;">$${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="font-size: 32px; color: #FF9800; font-weight: 900;">‚Üí</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/orders/${orderId}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load order');
                }
                
                const order = result.order;
                
                document.getElementById('ordersList').style.display = 'none';
                const detailDiv = document.getElementById('orderDetail');
                detailDiv.style.display = 'block';
                
                detailDiv.innerHTML = `
                    <button class="back-btn" onclick="backToList()">‚Üê Back to Orders</button>
                    
                    <div class="card">
                        <div class="restaurant-info">
                            <div class="order-date">${new Date(order.created_at).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</div>
                            <div class="restaurant-name">${order.restaurant}</div>
                            ${order.delivery_service && order.delivery_service !== 'Unknown' ? 
                                `<div class="delivery-badge">${order.delivery_service}</div>` : ''}
                            <div style="color: #666; margin-top: 8px; font-size: 15px;">üìç ${order.address}</div>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px 0; font-size: 20px; color: #4A4A1F; text-transform: uppercase;">Order Items</h3>
                        
                        <div id="itemsList">
                            ${order.items.map(item => `
                                <div class="item-card" id="item-${item.id}">
                                    <div class="item-view" id="view-${item.id}">
                                        <div class="item-header">
                                            <div class="item-name">${item.name}</div>
                                            <div class="item-price">$${parseFloat(item.price).toFixed(2)}</div>
                                        </div>
                                        
                                        ${item.assigned_to ? `
                                            <div style="margin: 10px 0;">
                                                <span class="person-badge ${item.assigned_to.toLowerCase()}">
                                                    üë§ ${item.assigned_to}
                                                </span>
                                            </div>
                                        ` : ''}
                                        
                                        ${item.rating > 0 ? `
                                            <div class="rating-display" style="margin: 10px 0;">
                                                ${'‚òÖ'.repeat(item.rating)}${'‚òÜ'.repeat(5 - item.rating)}
                                            </div>
                                        ` : ''}
                                        
                                        ${item.notes ? `
                                            <div class="notes-display">
                                                üí≠ ${item.notes}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="item-actions">
                                            <button class="edit-item-btn" onclick="editItem(${item.id})">‚úèÔ∏è Edit</button>
                                            <button class="delete-item-btn" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                    
                                    <div class="item-edit" id="edit-${item.id}" style="display: none;">
                                        <div class="item-header">
                                            <div class="item-name">
                                                <input type="text" id="name-${item.id}" value="${item.name}" />
                                            </div>
                                            <div class="item-price">
                                                <input type="number" step="0.01" id="price-${item.id}" value="${parseFloat(item.price).toFixed(2)}" />
                                            </div>
                                        </div>
                                        
                                        <div class="label-text">Who ate this?</div>
                                        <div class="assignment-buttons">
                                            <button class="assign-btn collin ${item.assigned_to === 'Collin' ? 'selected' : ''}" 
                                                    onclick="selectPerson(${item.id}, 'Collin')">
                                                üë§ Collin
                                            </button>
                                            <button class="assign-btn emily ${item.assigned_to === 'Emily' ? 'selected' : ''}" 
                                                    onclick="selectPerson(${item.id}, 'Emily')">
                                                üë§ Emily
                                            </button>
                                        </div>
                                        
                                        <div class="label-text">Rating</div>
                                        <div class="stars" id="stars-${item.id}">
                                            ${[1,2,3,4,5].map(star => 
                                                `<span class="star ${star <= item.rating ? 'filled' : 'empty'}" 
                                                       onclick="setRating(${item.id}, ${star})">‚òÖ</span>`
                                            ).join('')}
                                        </div>
                                        
                                        <div class="label-text">Notes</div>
                                        <textarea id="notes-${item.id}">${item.notes || ''}</textarea>
                                        
                                        <div class="item-actions">
                                            <button class="save-item-btn" onclick="saveItemEdit(${item.id}, ${orderId})">üíæ Save</button>
                                            <button class="cancel-item-btn" onclick="cancelItemEdit(${item.id})">‚úñÔ∏è Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="summary-box">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span>$${parseFloat(order.subtotal).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Delivery Fee</span>
                                <span>$${parseFloat(order.delivery_fee).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Service Fee</span>
                                <span>$${parseFloat(order.service_fee).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax</span>
                                <span>$${parseFloat(order.tax).toFixed(2)}</span>
                            </div>
                            ${order.discount !== 0 ? `
                                <div class="summary-row">
                                    <span>Discount</span>
                                    <span>-$${Math.abs(parseFloat(order.discount)).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="summary-row">
                                <span>Tip</span>
                                <span>$${parseFloat(order.tip).toFixed(2)}</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total</span>
                                <span>$${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <button class="delete-btn" onclick="deleteOrder(${order.id})">üóëÔ∏è Delete Order</button>
                    </div>
                `;
                
            } catch (error) {
                alert('Error loading order: ' + error.message);
            }
        }
        
        // Edit item functions
        function editItem(itemId) {
            document.getElementById(`view-${itemId}`).style.display = 'none';
            document.getElementById(`edit-${itemId}`).style.display = 'block';
        }
        
        function cancelItemEdit(itemId) {
            document.getElementById(`view-${itemId}`).style.display = 'block';
            document.getElementById(`edit-${itemId}`).style.display = 'none';
        }
        
        function selectPerson(itemId, person) {
            const buttons = document.querySelectorAll(`#edit-${itemId} .assign-btn`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            const btn = person === 'Collin' ? buttons[0] : buttons[1];
            btn.classList.add('selected');
        }
        
        function setRating(itemId, rating) {
            const stars = document.querySelectorAll(`#stars-${itemId} .star`);
            stars.forEach((star, i) => {
                star.className = i < rating ? 'star filled' : 'star empty';
            });
        }
        
        async function saveItemEdit(itemId, orderId) {
            const name = document.getElementById(`name-${itemId}`).value.trim();
            const price = parseFloat(document.getElementById(`price-${itemId}`).value);
            const notes = document.getElementById(`notes-${itemId}`).value.trim();
            
            const collinBtn = document.querySelector(`#edit-${itemId} .assign-btn.collin`);
            const emilyBtn = document.querySelector(`#edit-${itemId} .assign-btn.emily`);
            let assignedTo = null;
            if (collinBtn.classList.contains('selected')) assignedTo = 'Collin';
            if (emilyBtn.classList.contains('selected')) assignedTo = 'Emily';
            
            const filledStars = document.querySelectorAll(`#stars-${itemId} .star.filled`).length;
            const rating = filledStars;
            
            if (!name) {
                alert('Item name cannot be empty');
                return;
            }
            
            try {
                const response = await fetch(`/order-items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, assigned_to: assignedTo, rating, notes })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to update item');
                }
                
                // Refresh the order view
                viewOrder(orderId);
                
            } catch (error) {
                alert('Error saving item: ' + error.message);
            }
        }
        
        async function deleteItem(itemId) {
            if (!confirm('Delete this item?')) return;
            
            try {
                const response = await fetch(`/order-items/${itemId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete item');
                }
                
                // Remove the item card from view
                document.getElementById(`item-${itemId}`).remove();
                
            } catch (error) {
                alert('Error deleting item: ' + error.message);
            }
        }
        
        function backToList() {
            document.getElementById('ordersList').style.display = 'block';
            document.getElementById('orderDetail').style.display = 'none';
            loadOrders();
        }
        
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/orders/${orderId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete order');
                }
                
                alert('Order deleted successfully!');
                backToList();
                
            } catch (error) {
                alert('Error deleting order: ' + error.message);
            }
        }
        
        // Chat functionality
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('sendChatBtn');
            
            // Clear empty state if present
            if (messagesDiv.querySelector('.empty-state, div[style*="text-align: center"]')) {
                messagesDiv.innerHTML = '';
            }
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.textContent = message;
            messagesDiv.appendChild(userMsgDiv);
            
            // Clear input and disable button
            input.value = '';
            input.style.height = 'auto'; // Reset height
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div>';
            messagesDiv.appendChild(loadingDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        history: chatHistory
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get response');
                }
                
                // Remove loading
                messagesDiv.removeChild(loadingDiv);
                
                // Add assistant message
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'chat-message assistant';
                assistantMsgDiv.innerHTML = formatChatMessage(result.response);
                messagesDiv.appendChild(assistantMsgDiv);
                
                // Update chat history
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: result.response }
                );
                
                // Keep only last 10 messages
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
            } catch (error) {
                messagesDiv.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant';
                errorDiv.style.background = '#fff2f0';
                errorDiv.style.borderColor = '#ffccc7';
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                messagesDiv.appendChild(errorDiv);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        function formatChatMessage(text) {
            // Simple markdown-like formatting
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n\d+\. /g, '<br>$&');
            
            return formatted;
        }
        
        // Allow Enter to send (Shift+Enter for new line)
        const chatInput = document.getElementById('chatInput');
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // Auto-expand textarea as user types
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // VIEW NAVIGATION FUNCTIONS
        function showUpload() {
            showView('uploadView');
        }
        
        function showLogMeal() {
            showView('logMealView');
        }
        
        function showOrders() {
            showView('ordersView');
            loadOrders();
        }
        
        function showHistory() {
            showView('ordersView');
            loadOrders();
        }
        
        async function showMealHistory() {
            showView('mealHistoryView');
            await loadMealHistory();
        }
        
        function showRecipeListForLogging() {
            // Special flag to know we're logging a meal
            window.isLoggingMeal = true;
            showRecipeList();
        }
        
        // RECIPE LIST FUNCTIONS
        let allRecipes = [];
        let isViewingRecipeDetail = false; // Track if we're in recipe detail view
        
        async function showRecipeList() {
            showView('recipeListView');
            
            // Load recipes if not already loaded
            if (allRecipes.length === 0) {
                try {
                    const response = await fetch('/api/recipes');
                    if (!response.ok) {
                        throw new Error('Failed to load recipes');
                    }
                    allRecipes = await response.json();
                } catch (error) {
                    console.error('Error loading recipes:', error);
                    document.getElementById('recipeListContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #999;">Unable to load recipes. Please try again.</p></div>';
                    return;
                }
            }
            
            displayRecipes(allRecipes);
        }
        
        function filterRecipes() {
            const searchTerm = document.getElementById('recipeSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayRecipes(allRecipes);
                return;
            }
            
            const filtered = allRecipes.filter(recipe => {
                return recipe.name.toLowerCase().includes(searchTerm) ||
                       (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm)) ||
                       (recipe.tags && recipe.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
            });
            
            displayRecipes(filtered);
        }
        
        function displayRecipes(recipes) {
            const container = document.getElementById('recipeListContainer');
            const countDiv = document.getElementById('recipeCount');
            
            countDiv.textContent = `${recipes.length} recipe${recipes.length !== 1 ? 's' : ''}`;
            
            if (recipes.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #999; padding: 40px 0;">No recipes found.</p></div>';
                return;
            }
            
            container.innerHTML = recipes.map(recipe => `
                <div class="card clickable-card" onclick="showRecipeDetail('${recipe.name.replace(/'/g, "\\'")}')">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 20px; font-weight: 900; color: #4A4A1F; margin-bottom: 8px; text-transform: uppercase;">
                                ${recipe.name}
                            </h3>
                            
                            ${recipe.tags && recipe.tags.length > 0 ? renderTags(recipe.tags) : ''}
                            
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; font-size: 14px; color: #6B6B3D; font-weight: 600;">
                                ${recipe.prep_time && recipe.prep_time !== 'N/A' ? `<span>‚è±Ô∏è Prep: ${recipe.prep_time}</span>` : ''}
                                ${recipe.cook_time && recipe.cook_time !== 'N/A' ? `<span>üî• Cook: ${recipe.cook_time}</span>` : ''}
                                ${recipe.servings && recipe.servings !== 'N/A' ? `<span>üçΩÔ∏è Servings: ${recipe.servings}</span>` : ''}
                            </div>
                        </div>
                        
                        <div style="font-size: 32px; color: #FF9800; font-weight: 900;">‚Üí</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function showRecipeDetail(recipeName) {
            const recipe = allRecipes.find(r => r.name === recipeName);
            if (!recipe) return;
            
            // Track that we're viewing a recipe detail (for back button navigation)
            // Check if we came from recipe list view
            const recipeListView = document.getElementById('recipeListView');
            if (recipeListView && recipeListView.classList.contains('active')) {
                isViewingRecipeDetail = true;
            }
            
            // Simulate getting recommendation by directly setting the content
            currentChoice = 'cooking';
            const recTitle = document.getElementById('recTitle');
            const recContent = document.getElementById('recContent');
            
            recTitle.textContent = recipe.name;
            
            // Build the recipe HTML similar to server response
            let html = '<div class="rec-details">';
            
            // Info row
            html += '<div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 12px; flex-wrap: wrap;">';
            html += `<div style="text-align: center; flex: 1; min-width: 80px;"><div style="font-size: 28px; margin-bottom: 4px;">‚è±Ô∏è</div><div style="font-weight: 600; color: #4A4A1F; font-size: 14px;">Prep: ${recipe.prep_time || 'N/A'}</div></div>`;
            html += `<div style="text-align: center; flex: 1; min-width: 80px;"><div style="font-size: 28px; margin-bottom: 4px;">üî•</div><div style="font-weight: 600; color: #4A4A1F; font-size: 14px;">Cook: ${recipe.cook_time || 'N/A'}</div></div>`;
            html += `<div style="text-align: center; flex: 1; min-width: 80px;"><div style="font-size: 28px; margin-bottom: 4px;">üçΩÔ∏è</div><div style="font-weight: 600; color: #4A4A1F; font-size: 14px;">Servings: ${recipe.servings || 'N/A'}</div></div>`;
            html += '</div>';
            
            // Tags display
            if (recipe.tags && recipe.tags.length > 0) {
                html += '<div style="display: flex; justify-content: center; margin-bottom: 16px;">';
                html += renderTags(recipe.tags);
                html += '</div>';
            }
            
            // Toggle buttons (separate from content box)
            html += '<div class="recipe-toggles">';
            html += '<button class="recipe-toggle active" onclick="switchRecipeTab(\'ingredients\')">üìù Ingredients</button>';
            html += '<button class="recipe-toggle" onclick="switchRecipeTab(\'instructions\')">üë©üèª‚Äçüç≥ Instructions</button>';
            html += '</div>';
            
            // Content box with sections
            html += '<div class="recipe-content-box">';
            
            // Ingredients section
            html += '<div id="ingredients-section" class="recipe-section active">';
            if (recipe.ingredients) {
                const ingredients = recipe.ingredients.split('\n').filter(i => i.trim());
                html += '<ul>';
                ingredients.forEach(ing => {
                    html += `<li>${ing.trim()}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p>No ingredients listed.</p>';
            }
            html += '</div>';
            
            // Instructions section
            html += '<div id="instructions-section" class="recipe-section">';
            if (recipe.directions) {
                html += `<p>${recipe.directions.replace(/\n/g, '<br><br>')}</p>`;
            } else {
                html += '<p>No instructions available.</p>';
            }
            html += '</div>';
            
            html += '</div>'; // Close recipe-content-box
            
            // If logging a meal, add confirmation button
            if (window.isLoggingMeal) {
                html += `<div style="margin-top: 24px; text-align: center;">
                    <button onclick="confirmLogMeal('${recipe.name.replace(/'/g, "\\'")}')" 
                            style="padding: 16px 40px; background: linear-gradient(135deg, #52c41a 0%, #3fa218 100%); color: white; font-size: 18px; font-weight: 800; border: 4px solid #4A4A1F; border-radius: 8px; cursor: pointer; text-transform: uppercase; box-shadow: 5px 5px 0 rgba(74, 74, 31, 0.3);">
                        ‚úÖ Log This Meal
                    </button>
                </div>`;
            } else {
                // Source button (only show when not logging)
                if (recipe.source_url) {
                    html += `<div style="margin-top: 24px; text-align: center;"><a href="${recipe.source_url}" target="_blank" style="display: inline-block; padding: 12px 24px; background: #FF9800; color: white; text-decoration: none; font-weight: 800; border-radius: 8px; border: 4px solid #4A4A1F; transition: all 0.2s ease;">üåê View Original Recipe</a></div>`;
                }
            }
            
            html += '</div>';
            
            recContent.innerHTML = html;
            showView('recommendationView');
        }
        
        // CHAT FUNCTIONS
        function toggleChat() {
            document.getElementById('chatOverlay').classList.add('active');
        }
        
        function closeChat(event) {
            if (!event || event.target === document.getElementById('chatOverlay')) {
                document.getElementById('chatOverlay').classList.remove('active');
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.textContent = message;
            messagesDiv.appendChild(userMsgDiv);
            
            input.value = '';
            
            // Add loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div>';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history: chatHistory })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get response');
                }
                
                messagesDiv.removeChild(loadingDiv);
                
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'chat-message assistant';
                assistantMsgDiv.innerHTML = result.response.replace(/\n\n/g, '<br><br>');
                messagesDiv.appendChild(assistantMsgDiv);
                
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: result.response }
                );
                
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
            } catch (error) {
                messagesDiv.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant';
                errorDiv.style.background = '#FFEBEE';
                errorDiv.style.borderColor = '#EF5350';
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                messagesDiv.appendChild(errorDiv);
            } finally {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // Allow Enter to send
        document.getElementById('chatInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // MEAL LOGGING FUNCTIONS
        async function confirmLogMeal(recipeName) {
            if (!confirm(`Log "${recipeName}" to your meal history?`)) {
                return;
            }
            
            try {
                const response = await fetch('/log-meal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipeName })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to log meal');
                }
                
                alert('‚úÖ Meal logged successfully!');
                window.isLoggingMeal = false;
                goHome();
                
            } catch (error) {
                console.error('Error logging meal:', error);
                alert('‚ùå Failed to log meal: ' + error.message);
            }
        }
        
        async function markOrderAsMeal(orderId) {
            try {
                const response = await fetch(`/mark-as-meal/${orderId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to log meal');
                }
                
                alert('‚úÖ Meal logged to history!');
                goHome();
                
            } catch (error) {
                console.error('Error marking as meal:', error);
                alert('‚ùå Failed to log meal: ' + error.message);
            }
        }
        
        // MEAL HISTORY FUNCTIONS
        let allMeals = [];
        
        async function loadMealHistory() {
            try {
                const response = await fetch('/meal-history');
                if (!response.ok) {
                    throw new Error('Failed to load meal history');
                }
                
                const data = await response.json();
                allMeals = data.meals;
                displayMealHistory(allMeals);
                
            } catch (error) {
                console.error('Error loading meal history:', error);
                document.getElementById('mealsList').innerHTML = '<div class="card"><p style="text-align: center; color: #999;">Unable to load meal history.</p></div>';
            }
        }
        
        function filterMealHistory() {
            const searchTerm = document.getElementById('mealHistorySearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayMealHistory(allMeals);
                return;
            }
            
            const filtered = allMeals.filter(meal => {
                const name = meal.recipe_name || meal.restaurant || '';
                return name.toLowerCase().includes(searchTerm);
            });
            
            displayMealHistory(filtered);
        }
        
        function displayMealHistory(meals) {
            const container = document.getElementById('mealsList');
            const countDiv = document.getElementById('mealCount');
            
            countDiv.textContent = `${meals.length} meal${meals.length !== 1 ? 's' : ''} logged`;
            
            if (meals.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #999; padding: 40px 0;">No meals logged yet. Start by logging a meal!</p></div>';
                return;
            }
            
            container.innerHTML = meals.map(meal => {
                const isHomeCooked = !!meal.recipe_name;
                const name = meal.recipe_name || meal.restaurant;
                const date = new Date(meal.meal_date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="card clickable-card" onclick="viewMeal(${meal.id})">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: #999; font-weight: 600; margin-bottom: 8px;">
                                    ${formattedDate}
                                </div>
                                
                                <h3 style="font-size: 20px; font-weight: 900; color: #FF9800; margin-bottom: 8px;">
                                    ${name}
                                </h3>
                                
                                <div style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; border: 2px solid #4A4A1F; background: ${isHomeCooked ? '#52c41a' : '#FF9800'}; color: white;">
                                    ${isHomeCooked ? 'üè† Home Cooked' : 'üçî Take Out'}
                                </div>
                            </div>
                            
                            <div style="font-size: 32px; color: #FF9800; font-weight: 900;">‚Üí</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function viewMeal(mealId) {
            const meal = allMeals.find(m => m.id === mealId);
            if (!meal) return;
            
            const isHomeCooked = !!meal.recipe_name;
            
            if (isHomeCooked) {
                // Show recipe detail
                showRecipeDetail(meal.recipe_name);
            } else {
                // Show order detail (reuse existing function)
                viewOrder(mealId);
            }
        }
    </script>
</body>
</html>
