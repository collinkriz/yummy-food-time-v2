<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yummy Food Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #F5F1E8;
            min-height: 100vh;
            padding-bottom: 40px;
            position: relative;
        }
        
        /* Subtle texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(74, 74, 31, 0.02) 2px,
                    rgba(74, 74, 31, 0.02) 4px
                );
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 12px;
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
            padding: 28px 24px;
            margin-bottom: 20px;
            box-shadow: 
                8px 8px 0 rgba(74, 74, 31, 0.3),
                0 8px 24px rgba(0, 0, 0, 0.15);
            border: 4px solid #4A4A1F;
            position: relative;
            overflow: hidden;
        }
        
        .header::before,
        .header::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: #FF9800;
            border: 3px solid #4A4A1F;
        }
        
        .header::before {
            top: -30px;
            left: -30px;
            transform: rotate(45deg);
        }
        
        .header::after {
            bottom: -30px;
            right: -30px;
            transform: rotate(45deg);
            background: #6B6B3D;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 24px 20px;
            }
            
            .header::before,
            .header::after {
                width: 40px;
                height: 40px;
            }
            
            .header::before {
                top: -20px;
                left: -20px;
            }
            
            .header::after {
                bottom: -20px;
                right: -20px;
            }
        }
        
        h1 {
            color: #4A4A1F;
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 8px;
            text-shadow: 
                3px 3px 0 rgba(255, 255, 255, 0.4),
                -1px -1px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            letter-spacing: -1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        h1:hover {
            transform: scale(1.02);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 32px;
            }
            
            /* Logo responsive sizing */
            .header > div[onclick="goHome()"] > div {
                font-size: 28px !important;
                letter-spacing: 1px !important;
            }
        }
        
        .subtitle {
            color: #4A4A1F;
            font-size: 16px;
            font-weight: 700;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 2;
        }
        
        @media (max-width: 768px) {
            .subtitle {
                font-size: 14px;
            }
        }
        
        /* TOP BUTTONS */
        .top-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }
        
        .top-btn {
            flex: 1;
            padding: 12px 16px;
            background: #F5F1E8;
            border: 3px solid #4A4A1F;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.25);
        }
        
        .top-btn:hover {
            background: #FF9800;
            transform: translateY(-2px);
            box-shadow: 5px 5px 0 rgba(74, 74, 31, 0.3);
        }
        
        @media (max-width: 768px) {
            .top-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
        }
        
        /* VIEWS */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CHOICE CARDS (Take Out / Cook at Home) */
        .choice-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }
        
        @media (max-width: 768px) {
            .choice-cards {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .choice-card {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .choice-card::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            transition: top 0.3s ease;
            z-index: 0;
        }
        
        .choice-card:hover::before {
            top: 0;
        }
        
        .choice-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 10px 10px 0 rgba(74, 74, 31, 0.3);
        }
        
        .choice-icon {
            font-size: 80px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .choice-card:hover .choice-icon {
            transform: scale(1.2) rotate(10deg);
        }
        
        .choice-title {
            font-size: 28px;
            font-weight: 900;
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .choice-card:hover .choice-title {
            color: white;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .choice-card {
                padding: 50px 20px;
            }
            
            .choice-icon {
                font-size: 64px;
            }
            
            .choice-title {
                font-size: 24px;
            }
        }
        
        /* FILTER TILES */
        .filter-section {
            margin-top: 30px;
        }
        
        .filter-section h2 {
            color: #4A4A1F;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }
        
        .filter-tile {
            background: white;
            border: 4px solid #B4B85E;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 rgba(180, 184, 94, 0.2);
        }
        
        .filter-tile:hover {
            border-color: #FF9800;
            transform: translateY(-3px);
            box-shadow: 5px 5px 0 rgba(255, 152, 0, 0.3);
        }
        
        .filter-tile.selected {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-color: #4A4A1F;
            color: white;
            transform: scale(1.05);
        }
        
        .filter-tile.random {
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            border-color: #4A4A1F;
            color: #FFC107;
        }
        
        .filter-tile.random:hover {
            transform: scale(1.08) rotate(5deg);
        }
        
        .filter-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .filter-name {
            font-size: 16px;
            font-weight: 800;
            text-transform: uppercase;
        }
        
        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            color: #FFC107;
            border: 4px solid #4A4A1F;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 5px 5px 0 rgba(74, 74, 31, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.3);
        }
        
        @media (max-width: 768px) {
            .filter-btn {
                padding: 14px 30px;
                font-size: 16px;
            }
        }
        
        /* RECOMMENDATION SCREEN */
        .recommendation {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 40px 30px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            margin-top: 30px;
        }
        
        .rec-title {
            font-size: 32px;
            font-weight: 900;
            color: #FF9800;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .rec-info-header {
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            border: 3px solid #B4B85E;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .rec-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #4A4A1F;
        }
        
        .rec-info-item span {
            font-size: 20px;
        }
        
        /* Recipe Toggle Buttons (separate from content box) */
        .recipe-toggles {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            justify-content: center;
        }
        
        .recipe-toggle {
            flex: 1;
            max-width: 200px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #F5F1E8 0%, #E8E4D8 100%);
            border: 4px solid #4A4A1F;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4A4A1F;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            box-shadow: 3px 3px 0 rgba(74, 74, 31, 0.2);
            border-radius: 8px;
        }
        
        .recipe-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.3);
        }
        
        .recipe-toggle.active {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            box-shadow: 4px 4px 0 rgba(255, 152, 0, 0.3);
        }
        
        /* Recipe Content Box (simple bordered box) */
        .recipe-content-box {
            background: white;
            border: 4px solid #4A4A1F;
            padding: 24px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            margin-bottom: 20px;
        }
        
        .recipe-section {
            display: none;
        }
        
        .recipe-section.active {
            display: block;
        }
        
        .recipe-section h4 {
            font-size: 18px;
            font-weight: 800;
            color: #4A4A1F;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        
        .recipe-section ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }
        
        .recipe-section li {
            margin-bottom: 8px;
        }
        
        .recipe-section p {
            margin-bottom: 12px;
            white-space: pre-wrap;
        }
        
        .rec-content {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
        }
        
        .rec-details {
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            border: 4px solid #4A4A1F;
            border-bottom: none;
            padding: 20px;
            margin-bottom: 0;
        }
        
        .back-btn {
            background: linear-gradient(135deg, #78909C 0%, #607D8B 100%);
            color: white;
            padding: 14px 30px;
            border: 4px solid #4A4A1F;
            font-size: 16px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(69, 90, 100, 0.3);
            text-transform: uppercase;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 0 rgba(69, 90, 100, 0.3);
        }
        
        /* FLOATING CHAT BUTTON */
        .chat-float-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border: 4px solid #4A4A1F;
            border-radius: 50%;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                4px 4px 0 rgba(74, 74, 31, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .chat-float-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.4),
                6px 6px 0 rgba(74, 74, 31, 0.4);
        }
        
        @media (max-width: 768px) {
            .chat-float-btn {
                width: 56px;
                height: 56px;
                font-size: 28px;
                bottom: 20px;
                right: 20px;
            }
        }
        
        /* CHAT OVERLAY */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .chat-overlay.active {
            display: flex;
        }
        
        .chat-box {
            background: white;
            border: 4px solid #4A4A1F;
            box-shadow: 8px 8px 0 rgba(74, 74, 31, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #FFC107 0%, #FFD54F 100%);
            border-bottom: 4px solid #4A4A1F;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h3 {
            font-size: 24px;
            font-weight: 900;
            color: #4A4A1F;
            text-transform: uppercase;
        }
        
        .chat-close {
            background: #EF5350;
            border: 3px solid #4A4A1F;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #FEFDF8 0%, #FFF9E6 100%);
            min-height: 200px;
            max-height: 400px;
        }
        
        .chat-message {
            margin-bottom: 16px;
            padding: 14px 18px;
            border: 3px solid;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
            font-weight: 600;
            max-width: 80%;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
            color: white;
            border-color: #0288D1;
            margin-left: auto;
        }
        
        .chat-message.assistant {
            background: white;
            color: #333;
            border-color: #4A4A1F;
            margin-right: auto;
        }
        
        .chat-input-area {
            border-top: 4px solid #4A4A1F;
            padding: 16px;
            background: white;
            display: flex;
            gap: 12px;
        }
        
        #chatInput {
            flex: 1;
            padding: 12px;
            border: 3px solid #B4B85E;
            font-size: 15px;
            font-family: inherit;
            font-weight: 600;
        }
        
        #chatInput:focus {
            outline: none;
            border-color: #FF9800;
        }
        
        #sendChatBtn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6B6B3D 0%, #5A5A32 100%);
            color: #FFC107;
            border: 3px solid #4A4A1F;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        #sendChatBtn:hover {
            background: linear-gradient(135deg, #5A5A32 0%, #4A4A28 100%);
        }
        
        .spinner {
            border: 4px solid rgba(74, 74, 31, 0.2);
            border-top: 4px solid #FF9800;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* CARD */
        .card {
            background: white;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.2);
            border: 4px solid #4A4A1F;
        }
        
        /* UPLOAD AREA STYLING */
        .upload-area {
            border: 4px dashed #FF9800;
            padding: 60px 30px;
            text-align: center;
            background: linear-gradient(135deg, #FFF9E6 0%, #FFFBF0 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin: 20px 0;
        }
        
        .upload-area:hover {
            border-color: #6B6B3D;
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF9E6 100%);
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.15);
        }
        
        .upload-icon {
            font-size: 72px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        input[type="file"] {
            display: none;
        }
        
        .preview {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview img {
            max-width: 100%;
            height: auto;
            border: 4px solid #4A4A1F;
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.2);
        }
        
        button {
            width: 100%;
            padding: 18px 24px;
            background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);
            color: white;
            border: 4px solid #4A4A1F;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 4px 4px 0 rgba(74, 74, 31, 0.3);
        }
        
        button:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(74, 74, 31, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(74, 74, 31, 0.3);
        }
        
        button:disabled {
            background: #CCC;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        
        .status {
            padding: 16px 20px;
            margin: 16px 0;
            border: 4px solid;
            font-weight: 700;
            text-align: center;
        }
        
        .status.loading {
            background: #E3F2FD;
            border-color: #2196F3;
            color: #1565C0;
        }
        
        .status.success {
            background: #E8F5E9;
            border-color: #4CAF50;
            color: #2E7D32;
        }
        
        .status.error {
            background: #FFEBEE;
            border-color: #EF5350;
            color: #C62828;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div onclick="goHome()" style="cursor: pointer; text-align: center; margin-bottom: 16px;">
                <div style="font-size: 36px; font-weight: 900; color: #4A4A1F; text-transform: uppercase; letter-spacing: 2px; text-shadow: 3px 3px 0 rgba(255, 255, 255, 0.4), -1px -1px 0 rgba(0, 0, 0, 0.1); line-height: 1; margin-bottom: 4px;">
                    YUMMY FOOD TIME
                </div>
                <p class="subtitle" style="margin: 0;">Your food decision helper</p>
            </div>
            
            <div class="top-buttons">
                <button class="top-btn" onclick="showUpload()">üì∏ Upload</button>
                <button class="top-btn" onclick="showRecipeList()">üìñ Recipes</button>
                <button class="top-btn" onclick="showHistory()">üìã History</button>
            </div>
        </div>
        
        <!-- HOME VIEW -->
        <div id="homeView" class="view active">
            <div class="choice-cards">
                <div class="choice-card" onclick="selectChoice('takeout')">
                    <div class="choice-icon">üçî</div>
                    <div class="choice-title">Take Out</div>
                </div>
                <div class="choice-card" onclick="selectChoice('cooking')">
                    <div class="choice-icon">üë©üèª‚Äçüç≥</div>
                    <div class="choice-title">Cook at Home</div>
                </div>
            </div>
        </div>
        
        <!-- FILTER VIEW -->
        <div id="filterView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="filter-section">
                <h2 id="filterTitle">What are you looking for?</h2>
                <div class="filter-grid" id="filterGrid"></div>
                <div class="filter-actions">
                    <button class="filter-btn" onclick="getRecommendation()">Get Recommendation ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- RECOMMENDATION VIEW -->
        <div id="recommendationView" class="view">
            <button class="back-btn" onclick="backToFilters()">‚Üê Back</button>
            
            <div class="recommendation">
                <div class="rec-title" id="recTitle"></div>
                <div class="rec-content" id="recContent"></div>
                <div class="filter-actions">
                    <button class="filter-btn" onclick="getRecommendation()">üé≤ Try Again</button>
                </div>
            </div>
        </div>
        
        <!-- UPLOAD VIEW -->
        <div id="uploadView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üì∏ Upload Receipt</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∏</div>
                    <div style="color: #666;">Tap to upload food delivery receipt</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div id="preview" style="display: none;">
                    <img id="previewImage" alt="Preview">
                </div>
                
                <button id="extractBtn" disabled>Extract Order Info</button>
                
                <div id="status" style="display: none;"></div>
            </div>
            
            <div id="results" style="display: none;"></div>
        </div>
        
        <!-- HISTORY VIEW -->
        <div id="historyView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üìã Order History</h2>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 24px;">
                    <input 
                        type="text" 
                        id="historySearch" 
                        placeholder="üîç Search orders by restaurant..." 
                        style="width: 100%; padding: 16px; font-size: 16px; border: 4px solid #4A4A1F; border-radius: 12px; font-weight: 600; background: white;"
                        oninput="filterOrders()"
                    />
                </div>
                
                <!-- Order Count -->
                <div id="orderCount" style="margin-bottom: 16px; font-weight: 600; color: #6B6B3D; text-align: center;"></div>
            </div>
            
            <div id="ordersList"></div>
            <div id="orderDetail" style="display: none;"></div>
        </div>
        
        <!-- RECIPE LIST VIEW -->
        <div id="recipeListView" class="view">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: #FF9800;">üìñ Recipe Library</h2>
                
                <!-- Search Bar -->
                <div style="margin-bottom: 24px;">
                    <input 
                        type="text" 
                        id="recipeSearch" 
                        placeholder="üîç Search recipes..." 
                        style="width: 100%; padding: 16px; font-size: 16px; border: 4px solid #4A4A1F; border-radius: 12px; font-weight: 600; background: white;"
                        oninput="filterRecipes()"
                    />
                </div>
                
                <!-- Recipe Count -->
                <div id="recipeCount" style="margin-bottom: 16px; font-weight: 600; color: #6B6B3D; text-align: center;"></div>
            </div>
            
            <!-- Recipe List (cards outside main card for spacing) -->
            <div id="recipeListContainer"></div>
        </div>
    </div>
    
    <!-- FLOATING CHAT BUTTON -->
    <div class="chat-float-btn" onclick="toggleChat()">üí¨</div>
    
    <!-- CHAT OVERLAY -->
    <div class="chat-overlay" id="chatOverlay" onclick="closeChat(event)">
        <div class="chat-box" onclick="event.stopPropagation()">
            <div class="chat-header">
                <h3>ü§ñ Chat</h3>
                <div class="chat-close" onclick="closeChat()">√ó</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    What can I help you find?
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Ask me anything..." />
                <button id="sendChatBtn" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentOrder = null;
        let selectedFile = null;
        let currentView = 'home';
        let currentChoice = null;
        let selectedFilters = new Set();
        let chatHistory = [];
        
        const takeoutFilters = [
            { id: 'cheap', icon: 'üí∞', name: 'Cheap' },
            { id: 'healthy', icon: 'ü•ó', name: 'Healthy' },
            { id: 'filling', icon: 'üçó', name: 'Filling' },
            { id: 'fast', icon: '‚ö°', name: 'Fast' },
            { id: 'comfort', icon: 'üçï', name: 'Comfort' }
        ];
        
        const cookingFilters = [
            { id: 'healthy', icon: 'ü•ó', name: 'Healthy' },
            { id: 'quick', icon: '‚ö°', name: 'Quick' },
            { id: 'filling', icon: 'üçó', name: 'Filling' },
            { id: 'complex', icon: 'üéì', name: 'Complex' },
            { id: 'comfort', icon: 'üßÄ', name: 'Comfort' },
            { id: 'main', icon: 'üçΩÔ∏è', name: 'Main Dish' },
            { id: 'salad', icon: 'ü•ó', name: 'Salad' },
            { id: 'soup', icon: 'üçú', name: 'Soup' },
            { id: 'breakfast', icon: 'üç≥', name: 'Breakfast' },
            { id: 'dessert', icon: 'üç∞', name: 'Dessert' },
            { id: 'side', icon: 'ü•î', name: 'Side Dish' },
            { id: 'sauce', icon: 'ü•´', name: 'Sauce' },
            { id: 'appetizer', icon: 'üç§', name: 'Appetizer' }
        ];
        
        // View navigation functions
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.add('active');
            }
        }
        
        function goHome() {
            currentChoice = null;
            selectedFilters.clear();
            showView('homeView');
        }
        
        function selectChoice(choice) {
            currentChoice = choice;
            selectedFilters.clear();
            
            const filters = choice === 'takeout' ? takeoutFilters : cookingFilters;
            const filterGrid = document.getElementById('filterGrid');
            const filterTitle = document.getElementById('filterTitle');
            
            filterTitle.textContent = choice === 'takeout' ? 'What kind of takeout?' : 'What style of cooking?';
            
            filterGrid.innerHTML = filters.map(f => `
                <div class="filter-tile" data-filter="${f.id}" onclick="toggleFilter('${f.id}')">
                    <div class="filter-icon">${f.icon}</div>
                    <div class="filter-name">${f.name}</div>
                </div>
            `).join('');
            
            showView('filterView');
        }
        
        function toggleFilter(filterId) {
            const tile = document.querySelector(`[data-filter="${filterId}"]`);
            
            if (selectedFilters.has(filterId)) {
                selectedFilters.delete(filterId);
                tile.classList.remove('active');
            } else {
                selectedFilters.add(filterId);
                tile.classList.add('active');
            }
        }
        
        async function getRecommendation(forceRandom = false) {
            const recTitle = document.getElementById('recTitle');
            const recContent = document.getElementById('recContent');
            
            recTitle.textContent = 'Finding recommendation...';
            recContent.innerHTML = '<div class="spinner"></div>';
            showView('recommendationView');
            
            try {
                const params = new URLSearchParams({
                    type: currentChoice,
                    filters: Array.from(selectedFilters).join(','),
                    random: forceRandom
                });
                
                const response = await fetch(`/recommend?${params}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get recommendation');
                }
                
                recTitle.textContent = result.title || (currentChoice === 'takeout' ? 'Order This!' : 'Cook This!');
                recContent.innerHTML = result.recommendation;
                
            } catch (error) {
                console.error('Recommendation error:', error);
                recTitle.textContent = 'Oops!';
                recContent.textContent = error.message || 'Unable to get a recommendation. Please try again.';
            }
        }
        
        function backToFilters() {
            showView('filterView');
        }
        
        function switchRecipeTab(tabName) {
            document.querySelectorAll('.recipe-toggle').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.recipe-section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-section').classList.add('active');
        }
        
        // Tab switching (legacy - not used in new design)
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'upload') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('upload-tab').classList.add('active');
                currentView = 'upload';
            } else if (tab === 'history') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('history-tab').classList.add('active');
                currentView = 'history';
                loadOrders();
            } else if (tab === 'chat') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('chat-tab').classList.add('active');
                currentView = 'chat';
            }
        }
        
        // Upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const extractBtn = document.getElementById('extractBtn');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        
                        // Only constrain width, let height be flexible for long receipts
                        previewImage.style.maxWidth = '90%';
                        previewImage.style.width = 'auto';
                        previewImage.style.height = 'auto';
                        previewImage.style.maxHeight = 'none';
                        previewImage.style.objectFit = 'contain';
                        
                        preview.style.display = 'block';
                        extractBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        if (extractBtn) {
            extractBtn.addEventListener('click', extractOrder);
        }
        
        async function extractOrder() {
            if (!selectedFile) return;
            
            extractBtn.disabled = true;
            results.style.display = 'none';
            status.style.display = 'block';
            status.className = 'status loading';
            status.innerHTML = '<div class="spinner"></div><div>Analyzing receipt...</div>';
            
            try {
                const formData = new FormData();
                formData.append('image', selectedFile);
                
                const response = await fetch('/extract-order', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to extract order');
                }
                
                status.className = 'status success';
                status.textContent = '‚úÖ Order extracted! Add ratings and save.';
                
                currentOrder = result.data;
                currentOrder.items = currentOrder.items.map((item, i) => ({
                    ...item,
                    id: i,
                    assignedTo: null,
                    rating: 0,
                    notes: ''
                }));
                
                displayOrderForRating(currentOrder);
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error: ' + error.message;
            } finally {
                extractBtn.disabled = false;
            }
        }
        
        function displayOrderForRating(order) {
            results.style.display = 'block';
            results.innerHTML = `
                <div class="card">
                    <div class="restaurant-info">
                        <div class="restaurant-name">${order.restaurant}</div>
                        ${order.deliveryService && order.deliveryService !== 'Unknown' ? 
                            `<div class="delivery-badge">${order.deliveryService}</div>` : ''}
                        <div style="color: #666; margin-top: 8px;">üìç ${order.address}</div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px;">Rate Your Items</h3>
                    
                    <div id="itemsList">
                        ${order.items.map((item, i) => `
                            <div class="item-card">
                                <div class="item-header">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">$${item.price.toFixed(2)}</div>
                                </div>
                                
                                <div class="label-text">Who ate this?</div>
                                <div class="assignment-buttons">
                                    <button class="assign-btn collin" onclick="assignItem(${i}, 'Collin')">
                                        üë§ Collin
                                    </button>
                                    <button class="assign-btn emily" onclick="assignItem(${i}, 'Emily')">
                                        üë§ Emily
                                    </button>
                                </div>
                                
                                <div class="label-text">Rating</div>
                                <div class="stars" id="stars-${i}">
                                    ${[1,2,3,4,5].map(star => 
                                        `<span class="star empty" onclick="rateItem(${i}, ${star})">‚òÖ</span>`
                                    ).join('')}
                                </div>
                                
                                <div class="label-text">Notes</div>
                                <textarea 
                                    placeholder="Add your thoughts about this item..."
                                    onchange="updateNotes(${i}, this.value)"
                                ></textarea>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="summary-box">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>$${order.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>$${order.deliveryFee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Service Fee</span>
                            <span>$${order.serviceFee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax</span>
                            <span>$${order.tax.toFixed(2)}</span>
                        </div>
                        ${order.discount !== 0 ? `
                            <div class="summary-row">
                                <span>Discount</span>
                                <span>-$${Math.abs(order.discount).toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="summary-row">
                            <span>Tip</span>
                            <span>$${order.tip.toFixed(2)}</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>$${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <button class="save-btn" onclick="saveOrder()">üíæ Save Order</button>
                </div>
            `;
        }
        
        function assignItem(itemId, person) {
            currentOrder.items[itemId].assignedTo = person;
            
            // Update UI
            const buttons = document.querySelectorAll(`.item-card:nth-child(${itemId + 1}) .assign-btn`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            if (person === 'Collin') {
                buttons[0].classList.add('selected');
            } else {
                buttons[1].classList.add('selected');
            }
        }
        
        function rateItem(itemId, rating) {
            currentOrder.items[itemId].rating = rating;
            
            // Update stars UI
            const stars = document.querySelectorAll(`#stars-${itemId} .star`);
            stars.forEach((star, i) => {
                if (i < rating) {
                    star.className = 'star filled';
                } else {
                    star.className = 'star empty';
                }
            });
        }
        
        function updateNotes(itemId, notes) {
            currentOrder.items[itemId].notes = notes;
        }
        
        async function saveOrder() {
            try {
                status.style.display = 'block';
                status.className = 'status loading';
                status.textContent = 'Saving order...';
                
                // Prepare order data with correct structure
                const orderToSave = {
                    restaurant: currentOrder.restaurant,
                    address: currentOrder.address,
                    deliveryService: currentOrder.deliveryService,
                    subtotal: parseFloat(currentOrder.subtotal) || 0,
                    deliveryFee: parseFloat(currentOrder.deliveryFee) || 0,
                    serviceFee: parseFloat(currentOrder.serviceFee) || 0,
                    tax: parseFloat(currentOrder.tax) || 0,
                    discount: parseFloat(currentOrder.discount) || 0,
                    tip: parseFloat(currentOrder.tip) || 0,
                    total: parseFloat(currentOrder.total) || 0,
                    items: currentOrder.items.map(item => ({
                        name: item.name,
                        price: parseFloat(item.price) || 0,
                        assignedTo: item.assignedTo || null,
                        rating: parseInt(item.rating) || 0,
                        notes: item.notes || null
                    }))
                };
                
                console.log('Sending order data:', orderToSave);
                
                const response = await fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderToSave)
                });
                
                const result = await response.json();
                console.log('Server response:', result);
                
                if (!response.ok) {
                    console.error('Server error:', result);
                    // Show detailed error
                    throw new Error(result.error + (result.details ? '\n\nDetails: ' + result.details : ''));
                }
                
                status.className = 'status success';
                status.textContent = '‚úÖ Order saved successfully!';
                
                setTimeout(() => {
                    // Reset form
                    selectedFile = null;
                    currentOrder = null;
                    preview.style.display = 'none';
                    results.style.display = 'none';
                    status.style.display = 'none';
                    extractBtn.disabled = true;
                    fileInput.value = '';
                    
                    // Switch to history
                    switchTab('history');
                }, 1500);
                
            } catch (error) {
                console.error('Save order error:', error);
                status.className = 'status error';
                status.innerHTML = `‚ùå Error: ${error.message}<br><br><small>Check if database is connected in Railway</small>`;
            }
        }
        
        // History functionality
        let allOrders = [];
        
        async function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            const orderCount = document.getElementById('orderCount');
            ordersList.innerHTML = '<div class="card"><p style="text-align: center; color: #999;">Loading orders...</p></div>';
            
            try {
                const response = await fetch('/orders');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load orders');
                }
                
                allOrders = result.orders;
                displayOrders(allOrders);
                
            } catch (error) {
                ordersList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #EF5350;">‚ùå Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function filterOrders() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayOrders(allOrders);
                return;
            }
            
            const filtered = allOrders.filter(order => {
                return order.restaurant.toLowerCase().includes(searchTerm) ||
                       (order.delivery_service && order.delivery_service.toLowerCase().includes(searchTerm));
            });
            
            displayOrders(filtered);
        }
        
        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            const orderCount = document.getElementById('orderCount');
            
            orderCount.textContent = `${orders.length} order${orders.length !== 1 ? 's' : ''}`;
            
            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="card empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div style="font-size: 18px; margin-bottom: 10px; font-weight: 600;">No orders found</div>
                        <div style="color: #999;">Try a different search or upload your first receipt!</div>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = orders.map(order => `
                <div class="card" style="cursor: pointer; transition: all 0.2s ease;" 
                     onclick="viewOrder(${order.id})"
                     onmouseover="this.style.transform='translateY(-4px)'"
                     onmouseout="this.style.transform='translateY(0)'">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #999; font-weight: 600; margin-bottom: 8px;">
                                ${new Date(order.created_at).toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    month: 'short', 
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                            
                            <h3 style="font-size: 20px; font-weight: 900; color: #FF9800; margin-bottom: 8px;">
                                ${order.restaurant}
                            </h3>
                            
                            ${order.delivery_service && order.delivery_service !== 'Unknown' ? `
                                <div style="display: inline-block; background: linear-gradient(135deg, #6B6B3D 0%, #4A4A1F 100%); padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 700; color: white; margin-bottom: 8px;">
                                    ${order.delivery_service}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; font-size: 14px; color: #666; font-weight: 600;">
                                <span>üçΩÔ∏è ${order.items.length} item${order.items.length !== 1 ? 's' : ''}</span>
                                <span style="color: #4CAF50; font-weight: 900; font-size: 16px;">$${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="font-size: 32px; color: #FF9800; font-weight: 900;">‚Üí</div>
                    </div>
                </div>
            `).join('');
        }
                `;
            }
        }
        
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/orders/${orderId}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load order');
                }
                
                const order = result.order;
                
                document.getElementById('ordersList').style.display = 'none';
                const detailDiv = document.getElementById('orderDetail');
                detailDiv.style.display = 'block';
                
                detailDiv.innerHTML = `
                    <button class="back-btn" onclick="backToList()">‚Üê Back to Orders</button>
                    
                    <div class="card">
                        <div class="restaurant-info">
                            <div class="order-date">${new Date(order.created_at).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</div>
                            <div class="restaurant-name">${order.restaurant}</div>
                            ${order.delivery_service && order.delivery_service !== 'Unknown' ? 
                                `<div class="delivery-badge">${order.delivery_service}</div>` : ''}
                            <div style="color: #666; margin-top: 8px;">üìç ${order.address}</div>
                        </div>
                        
                        <h3 style="margin: 20px 0 15px 0;">Order Items</h3>
                        
                        ${order.items.map(item => `
                            <div class="item-card">
                                <div class="item-header">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">$${parseFloat(item.price).toFixed(2)}</div>
                                </div>
                                
                                ${item.assignedTo ? `
                                    <div style="margin: 10px 0;">
                                        <span style="background: ${item.assignedTo === 'Collin' ? '#1890ff' : '#722ed1'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                            üë§ ${item.assignedTo}
                                        </span>
                                    </div>
                                ` : ''}
                                
                                ${item.rating > 0 ? `
                                    <div style="margin: 10px 0;">
                                        <div style="color: #faad14; font-size: 20px;">
                                            ${'‚òÖ'.repeat(item.rating)}${'‚òÜ'.repeat(5 - item.rating)}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${item.notes ? `
                                    <div style="margin: 10px 0; padding: 12px; background: white; border-radius: 8px; font-size: 14px; color: #666;">
                                        üí≠ ${item.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                        
                        <div class="summary-box">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span>$${parseFloat(order.subtotal).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Delivery Fee</span>
                                <span>$${parseFloat(order.delivery_fee).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Service Fee</span>
                                <span>$${parseFloat(order.service_fee).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax</span>
                                <span>$${parseFloat(order.tax).toFixed(2)}</span>
                            </div>
                            ${order.discount !== 0 ? `
                                <div class="summary-row">
                                    <span>Discount</span>
                                    <span>-$${Math.abs(parseFloat(order.discount)).toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="summary-row">
                                <span>Tip</span>
                                <span>$${parseFloat(order.tip).toFixed(2)}</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total</span>
                                <span>$${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <button class="delete-btn" onclick="deleteOrder(${order.id})">üóëÔ∏è Delete Order</button>
                    </div>
                `;
                
            } catch (error) {
                alert('Error loading order: ' + error.message);
            }
        }
        
        function backToList() {
            document.getElementById('ordersList').style.display = 'block';
            document.getElementById('orderDetail').style.display = 'none';
            loadOrders();
        }
        
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/orders/${orderId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete order');
                }
                
                alert('Order deleted successfully!');
                backToList();
                
            } catch (error) {
                alert('Error deleting order: ' + error.message);
            }
        }
        
        // Chat functionality
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('sendChatBtn');
            
            // Clear empty state if present
            if (messagesDiv.querySelector('.empty-state, div[style*="text-align: center"]')) {
                messagesDiv.innerHTML = '';
            }
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.textContent = message;
            messagesDiv.appendChild(userMsgDiv);
            
            // Clear input and disable button
            input.value = '';
            input.style.height = 'auto'; // Reset height
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div>';
            messagesDiv.appendChild(loadingDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        history: chatHistory
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get response');
                }
                
                // Remove loading
                messagesDiv.removeChild(loadingDiv);
                
                // Add assistant message
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'chat-message assistant';
                assistantMsgDiv.innerHTML = formatChatMessage(result.response);
                messagesDiv.appendChild(assistantMsgDiv);
                
                // Update chat history
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: result.response }
                );
                
                // Keep only last 10 messages
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
            } catch (error) {
                messagesDiv.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant';
                errorDiv.style.background = '#fff2f0';
                errorDiv.style.borderColor = '#ffccc7';
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                messagesDiv.appendChild(errorDiv);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        function formatChatMessage(text) {
            // Simple markdown-like formatting
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n\d+\. /g, '<br>$&');
            
            return formatted;
        }
        
        // Allow Enter to send (Shift+Enter for new line)
        const chatInput = document.getElementById('chatInput');
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // Auto-expand textarea as user types
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // VIEW NAVIGATION FUNCTIONS
        function showUpload() {
            showView('uploadView');
        }
        
        function showHistory() {
            showView('historyView');
            loadOrders();
        }
        
        // RECIPE LIST FUNCTIONS
        let allRecipes = [];
        
        async function showRecipeList() {
            showView('recipeListView');
            
            // Load recipes if not already loaded
            if (allRecipes.length === 0) {
                try {
                    const response = await fetch('/api/recipes');
                    if (!response.ok) {
                        throw new Error('Failed to load recipes');
                    }
                    allRecipes = await response.json();
                } catch (error) {
                    console.error('Error loading recipes:', error);
                    document.getElementById('recipeListContainer').innerHTML = '<div class="card"><p style="text-align: center; color: #999;">Unable to load recipes. Please try again.</p></div>';
                    return;
                }
            }
            
            displayRecipes(allRecipes);
        }
        
        function filterRecipes() {
            const searchTerm = document.getElementById('recipeSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayRecipes(allRecipes);
                return;
            }
            
            const filtered = allRecipes.filter(recipe => {
                return recipe.name.toLowerCase().includes(searchTerm) ||
                       (recipe.category && recipe.category.some(cat => cat.toLowerCase().includes(searchTerm))) ||
                       (recipe.ingredients && recipe.ingredients.toLowerCase().includes(searchTerm));
            });
            
            displayRecipes(filtered);
        }
        
        function displayRecipes(recipes) {
            const container = document.getElementById('recipeListContainer');
            const countDiv = document.getElementById('recipeCount');
            
            countDiv.textContent = `${recipes.length} recipe${recipes.length !== 1 ? 's' : ''}`;
            
            if (recipes.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align: center; color: #999; padding: 40px 0;">No recipes found.</p></div>';
                return;
            }
            
            container.innerHTML = recipes.map(recipe => `
                <div class="card" style="cursor: pointer; transition: all 0.2s ease; position: relative;" 
                     onclick="showRecipeDetail('${recipe.name.replace(/'/g, "\\'")}')"
                     onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='8px 8px 0 rgba(74, 74, 31, 0.3)'"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='6px 6px 0 rgba(74, 74, 31, 0.2)'">
                    
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 20px; font-weight: 900; color: #4A4A1F; margin-bottom: 8px; text-transform: uppercase;">
                                ${recipe.name}
                            </h3>
                            
                            ${recipe.category ? `
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                    ${recipe.category.map(c => `
                                        <span style="background: linear-gradient(135deg, #FFE082 0%, #FFD54F 100%); 
                                                     padding: 4px 10px; 
                                                     border-radius: 6px; 
                                                     font-size: 12px; 
                                                     font-weight: 700; 
                                                     color: #4A4A1F; 
                                                     text-transform: uppercase; 
                                                     letter-spacing: 0.5px;
                                                     border: 2px solid #4A4A1F;">
                                            ${c}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; font-size: 14px; color: #6B6B3D; font-weight: 600;">
                                ${recipe.prep_time && recipe.prep_time !== 'N/A' ? `<span>‚è±Ô∏è Prep: ${recipe.prep_time}</span>` : ''}
                                ${recipe.cook_time && recipe.cook_time !== 'N/A' ? `<span>üî• Cook: ${recipe.cook_time}</span>` : ''}
                                ${recipe.servings && recipe.servings !== 'N/A' ? `<span>üçΩÔ∏è Servings: ${recipe.servings}</span>` : ''}
                            </div>
                        </div>
                        
                        <div style="font-size: 32px; color: #FF9800; font-weight: 900;">‚Üí</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function showRecipeDetail(recipeName) {
            const recipe = allRecipes.find(r => r.name === recipeName);
            if (!recipe) return;
            
            // Simulate getting recommendation by directly setting the content
            currentChoice = 'cooking';
            const recTitle = document.getElementById('recTitle');
            const recContent = document.getElementById('recContent');
            
            recTitle.textContent = recipe.name;
            
            // Build the recipe HTML similar to server response
            let html = '<div class="rec-details">';
            
            // Info row
            html += '<div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">';
            html += `<div style="text-align: center;"><div style="font-size: 24px;">‚è±Ô∏è</div><div style="font-weight: 600; color: #4A4A1F;">Prep: ${recipe.prep_time || 'N/A'}</div></div>`;
            html += `<div style="text-align: center;"><div style="font-size: 24px;">üî•</div><div style="font-weight: 600; color: #4A4A1F;">Cook: ${recipe.cook_time || 'N/A'}</div></div>`;
            html += `<div style="text-align: center;"><div style="font-size: 24px;">üçΩÔ∏è</div><div style="font-weight: 600; color: #4A4A1F;">Servings: ${recipe.servings || 'N/A'}</div></div>`;
            html += '</div>';
            
            // Toggle buttons (separate from content box)
            html += '<div class="recipe-toggles">';
            html += '<button class="recipe-toggle active" onclick="switchRecipeTab(\'ingredients\')">üìù Ingredients</button>';
            html += '<button class="recipe-toggle" onclick="switchRecipeTab(\'instructions\')">üë©üèª‚Äçüç≥ Instructions</button>';
            html += '</div>';
            
            // Content box with sections
            html += '<div class="recipe-content-box">';
            
            // Ingredients section
            html += '<div id="ingredients-section" class="recipe-section active">';
            if (recipe.ingredients) {
                const ingredients = recipe.ingredients.split('\n').filter(i => i.trim());
                html += '<ul>';
                ingredients.forEach(ing => {
                    html += `<li>${ing.trim()}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p>No ingredients listed.</p>';
            }
            html += '</div>';
            
            // Instructions section
            html += '<div id="instructions-section" class="recipe-section">';
            if (recipe.directions) {
                html += `<p>${recipe.directions.replace(/\n/g, '<br><br>')}</p>`;
            } else {
                html += '<p>No instructions available.</p>';
            }
            html += '</div>';
            
            html += '</div>'; // Close recipe-content-box
            
            // Source button
            if (recipe.source_url) {
                html += `<div style="margin-top: 24px; text-align: center;"><a href="${recipe.source_url}" target="_blank" style="display: inline-block; padding: 12px 24px; background: #FF9800; color: white; text-decoration: none; font-weight: 800; border-radius: 8px; border: 4px solid #4A4A1F; transition: all 0.2s ease;">üåê View Original Recipe</a></div>`;
            }
            
            html += '</div>';
            
            recContent.innerHTML = html;
            showView('recommendationView');
        }
        
        // CHAT FUNCTIONS
        function toggleChat() {
            document.getElementById('chatOverlay').classList.add('active');
        }
        
        function closeChat(event) {
            if (!event || event.target === document.getElementById('chatOverlay')) {
                document.getElementById('chatOverlay').classList.remove('active');
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesDiv = document.getElementById('chatMessages');
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.textContent = message;
            messagesDiv.appendChild(userMsgDiv);
            
            input.value = '';
            
            // Add loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0;"></div>';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history: chatHistory })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to get response');
                }
                
                messagesDiv.removeChild(loadingDiv);
                
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'chat-message assistant';
                assistantMsgDiv.innerHTML = result.response.replace(/\n\n/g, '<br><br>');
                messagesDiv.appendChild(assistantMsgDiv);
                
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: result.response }
                );
                
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
            } catch (error) {
                messagesDiv.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant';
                errorDiv.style.background = '#FFEBEE';
                errorDiv.style.borderColor = '#EF5350';
                errorDiv.textContent = '‚ùå Error: ' + error.message;
                messagesDiv.appendChild(errorDiv);
            } finally {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // Allow Enter to send
        document.getElementById('chatInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
    </script>
</body>
</html>
